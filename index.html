<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2048 éŠæˆ²</title>
    <style>
        body {
            font-family: 'Clear Sans', 'Helvetica Neue', Arial, sans-serif;
            background-color: #faf8ef;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #776e65;
            overflow-y: auto; /* å…è¨±æ»¾å‹•ä»¥ä¾¿åœ¨å°è¢å¹•ä¸Šé¡¯ç¤ºæ‰€æœ‰å…§å®¹ */
        }

        h1 {
            font-size: 50px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #776e65;
        }

        /* éŠæˆ²è³‡è¨Šå€å¡Šï¼ˆåˆ†æ•¸ã€æœ€é«˜åˆ†ã€è¨ˆæ™‚å™¨ï¼‰ */
        #game-info-area { /* å°‡ game-info æ›´åç‚º game-info-areaï¼ŒåŒ…å«åˆ†æ•¸ã€è¨ˆæ™‚ã€é«˜åˆ†å’Œæ–°åŠ å…¥çš„é‡æ–°é–‹å§‹æŒ‰éˆ• */
            display: flex;
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px; /* é …ç›®ä¹‹é–“çš„é–“è· */
        }

        #score-board, #high-score-board, #timer-display-container {
            background-color: #bbada0;
            color: #f9f6f2;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #score-board span, #high-score-board span, #timer-display-container span {
            font-size: 28px;
            font-weight: bolder;
        }

        /* æ–°å¢çš„ç¨ç«‹é‡æ–°é–‹å§‹æŒ‰éˆ• */
        #restart-button-always {
            display: none; /* é è¨­éš±è—ï¼ŒéŠæˆ²é–‹å§‹å¾Œé¡¯ç¤º */
            padding: 10px 20px;
            font-size: 18px;
            font-weight: bold;
            color: #f9f6f2;
            background-color: #8f7a66;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px; /* èª¿æ•´èˆ‡ä¸Šæ–¹å…ƒç´ çš„é–“è· */
            transition: background-color 0.3s;
        }

        #restart-button-always:hover {
            background-color: #9f8b7b;
        }

        /* éŠæˆ²æ¿å’Œæ–¹å¡Šæ¨£å¼ */
        #game-board {
            display: grid;
            background-color: #bbada0;
            padding: 10px;
            border-radius: 10px;
            /* å‹•æ…‹è¨­å®šç¶²æ ¼åˆ—æ•¸å’Œæ–¹å¡Šå¤§å° */
            grid-template-columns: repeat(var(--board-size), var(--tile-size));
            grid-gap: var(--grid-gap); /* ä½¿ç”¨ CSS è®Šæ•¸æ§åˆ¶é–“è· */
            max-width: calc(var(--tile-size) * var(--board-size) + var(--grid-gap) * (var(--board-size) + 1)); /* ç¢ºä¿æ¿é¢ä¸æœƒéå¤§ */
            min-width: 320px; /* æœ€å°å¯¬åº¦ç¢ºä¿åœ¨å°è¢å¹•ä¸Šä¸æœƒå¤ªå° */
            box-sizing: border-box; /* å…§é‚Šè·å’Œé‚Šæ¡†ä¸å¢åŠ ç¸½å¯¬åº¦ */
        }

        /* æ–¹å¡Š(tile)çš„é€šç”¨æ¨£å¼ */
        .tile {
            width: var(--tile-size);
            height: var(--tile-size);
            background-color: #cdc1b4; /* é è¨­èƒŒæ™¯é¡è‰² */
            display: flex; /* ä½¿ç”¨ Flexbox å±…ä¸­å…§å®¹ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            font-size: 36px; /* å­—é«”å¤§å° */
            font-weight: bold; /* å­—é«”ç²—ç´° */
            color: #776e65; /* å­—é«”é¡è‰² */
            border-radius: 5px; /* åœ“è§’ */
            transition: transform 0.2s, background-color 0.2s; /* å¹³æ»‘éæ¸¡æ•ˆæœ */
        }

        /* æ ¹æ“šæ–¹å¡Šæ•¸å€¼èª¿æ•´å­—é«”å¤§å°å’Œé¡è‰² */
        .tile[data-value="128"], .tile[data-value="256"], .tile[data-value="512"] { font-size: 30px; }
        .tile[data-value="1024"], .tile[data-value="2048"] { font-size: 24px; }

        /* æ•¸å€¼é¡è‰²æ¨£å¼ */
        .tile[data-value="2"] { background-color: #eee4da; }
        .tile[data-value="4"] { background-color: #ede0c8; }
        .tile[data-value="8"] { background-color: #f2b179; color: #f9f6f2; }
        .tile[data-value="16"] { background-color: #f59563; color: #f9f9f2; }
        .tile[data-value="32"] { background-color: #f67c5f; color: #f9f6f2; }
        .tile[data-value="64"] { background-color: #f65e3b; color: #f9f6f2; }
        .tile[data-value="128"] { background-color: #edcf72; color: #f9f6f2; }
        .tile[data-value="256"] { background-color: #edcc61; color: #f9f6f2; }
        .tile[data-value="512"] { background-color: #edc850; color: #f9f6f2; }
        .tile[data-value="1024"] { background-color: #edc53f; color: #f9f6f2; }
        .tile[data-value="2048"] { background-color: #edc22e; color: #f9f6f2; }

        /* éŠæˆ²çµæŸ/å‹åˆ©/æ•™å­¸è¨Šæ¯ - å½ˆå‡ºæ¡†æ¨£å¼ */
        #game-over {
            display: none; /* é è¨­éš±è— */
            position: fixed; /* å›ºå®šåœ¨è¦–çª—ä¸­ */
            top: 50%; /* å‚ç›´ç½®ä¸­ */
            left: 50%; /* æ°´å¹³ç½®ä¸­ */
            transform: translate(-50%, -50%); /* ç²¾ç¢ºç½®ä¸­ */
            background-color: rgba(255, 255, 255, 0.9); /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); /* é™°å½±æ•ˆæœ */
            padding: 30px;
            text-align: center;
            font-size: 28px; /* èª¿æ•´å­—é«”å¤§å° */
            font-weight: bold;
            color: #776e65;
            z-index: 100; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            max-width: 80%; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            min-width: 280px; /* æœ€å°å¯¬åº¦ */
            border: 2px solid #bbada0; /* æ·»åŠ é‚Šæ¡† */
            opacity: 0; /* åˆå§‹é€æ˜åº¦ç‚º0ï¼Œç”¨æ–¼æ·¡å…¥æ•ˆæœ */
            transition: opacity 0.3s ease-in-out; /* æ·¡å…¥æ·¡å‡ºéæ¸¡ */
        }

        #game-over.show {
            opacity: 1; /* é¡¯ç¤ºæ™‚é€æ˜åº¦ç‚º1 */
        }

        #game-over p {
            margin-bottom: 25px; /* å¢åŠ è¨Šæ¯èˆ‡æŒ‰éˆ•é–“è· */
            line-height: 1.5; /* è¡Œé«˜ */
        }

        /* éŠæˆ²çµæŸå½ˆçª—å…§çš„ã€Œé‡æ–°é–‹å§‹ã€æŒ‰éˆ•ï¼Œèˆ‡ç¨ç«‹çš„æŒ‰éˆ•å€åˆ† */
        #game-over button {
            padding: 15px 30px;
            font-size: 22px; /* èª¿æ•´æŒ‰éˆ•å­—é«”å¤§å° */
            font-weight: bold;
            color: #f9f6f2;
            background-color: #8f7a66;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px; /* èª¿æ•´æŒ‰éˆ•ä¸Šé‚Šè· */
            transition: background-color 0.3s;
        }

        #game-over button:hover {
            background-color: #9f8b7b;
        }

        /* é›£åº¦é¸æ“‡å€å¡Š */
        #difficulty-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        #difficulty-selection h2 {
            font-size: 32px;
            margin-bottom: 20px;
            color: #776e65;
        }

        #difficulty-selection button {
            padding: 15px 30px;
            font-size: 24px;
            font-weight: bold;
            color: #f9f6f2;
            background-color: #8f7a66;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            width: 200px;
            transition: background-color 0.3s;
        }

        #difficulty-selection button:hover {
            background-color: #9f8b7b;
        }

        /* å›åˆ°ä¸»é æŒ‰éˆ• */
        #home-button {
            display: none; /* é è¨­éš±è— */
            padding: 10px 20px;
            font-size: 18px;
            font-weight: bold;
            color: #f9f9f2;
            background-color: #8f7a66;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        #home-button:hover {
            background-color: #9f8b7b;
        }

        /* æ„è¦‹åé¥‹æŒ‰éˆ•å’Œé¸é … */
        #main-feedback-button {
            position: fixed; /* å›ºå®šåœ¨é é¢å³ä¸‹è§’ */
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            font-size: 18px;
            font-weight: bold;
            color: #f9f6f2;
            background-color: #4CAF50; /* ç¶ è‰² */
            border: none;
            border-radius: 50px; /* åœ“å½¢æŒ‰éˆ• */
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: background-color 0.3s;
        }

        #main-feedback-button:hover {
            background-color: #45a049;
        }

        #feedback-options {
            display: none; /* é è¨­éš±è— */
            flex-direction: column;
            position: fixed;
            bottom: 90px; /* åœ¨ä¸»è¦æŒ‰éˆ•ä¸Šæ–¹ */
            right: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden; /* ç¢ºä¿åœ“è§’æ•ˆæœ */
            z-index: 99;
        }

        #feedback-options button {
            padding: 12px 20px;
            font-size: 16px;
            color: #333;
            background-color: white;
            border: none;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.2s;
        }

        #feedback-options button:last-child {
            border-bottom: none;
        }

        #feedback-options button:hover {
            background-color: #f0f0f0;
        }

        /* æš«åœæŒ‰éˆ• */
        #pause-button {
            display: none; /* é è¨­éš±è— */
            padding: 10px 20px;
            font-size: 18px;
            font-weight: bold;
            color: #f9f6f2;
            background-color: #6a6a6a; /* æ·±ç°è‰² */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        #pause-button:hover {
            background-color: #555555;
        }

        #pause-button.paused {
            background-color: #d9534f; /* æš«åœæ™‚é¡¯ç¤ºç´…è‰² */
        }
        #pause-button.paused:hover {
            background-color: #c9302c;
        }

        /* å˜´ç ²æ¨¡å¼é–‹é—œ */
        #roast-mode-toggle-container {
            display: flex;
            align-items: center;
            margin-top: 20px;
            background-color: #f0d8a8; /* æ·ºé»ƒè‰²èƒŒæ™¯ */
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #roast-mode-toggle-container label {
            font-size: 18px;
            font-weight: bold;
            color: #776e65;
            margin-right: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #4CAF50;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(16px);
            -ms-transform: translateX(16px);
            transform: translateX(16px);
        }

        /* --- æ–°å¢çš„èªè­‰ç›¸é—œ CSS --- */
        #auth-header-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            color: #f9f6f2;
            background-color: #8f7a66;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            z-index: 101; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #auth-header-button:hover {
            background-color: #9f8b7b;
        }

        #auth-header-button.user-logged-in {
            background-color: #5cb85c; /* ç™»å…¥å¾Œæ›å€‹é¡è‰² */
        }
        #auth-header-button.user-logged-in:hover {
            background-color: #4cae4c;
        }

        /* èªè­‰å½ˆå‡ºè¦–çª— */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 200; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            position: relative;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .auth-form-container h2, .settings-form-container h2 {
            color: #776e65;
            margin-bottom: 20px;
        }

        .auth-form-container input, .settings-form-container input, .settings-form-container select {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .auth-form-container button, .settings-form-container button {
            width: 100%;
            padding: 12px;
            background-color: #8f7a66;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }

        .auth-form-container button:hover, .settings-form-container button:hover {
            background-color: #9f8b7b;
        }

        #google-signin-btn-modal {
            background-color: #db4437; /* Google red */
        }

        #google-signin-btn-modal:hover {
            background-color: #c33d2e;
        }

        /* æ–°å¢çš„æŒ‰éˆ•çµ„æ¨£å¼ */
        .auth-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .auth-options button {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #f9f6f2;
            background-color: #bbada0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .auth-options button:hover {
            background-color: #cdc1b4;
        }

        /* è¡¨å–®åˆ‡æ›é¡¯ç¤º */
        #login-form-modal, #register-form-modal, #phone-auth-modal, #account-settings-modal, #main-settings-modal {
            display: none;
        }

        /* ç™»å…¥å¾Œç”¨æˆ¶è³‡è¨Šå’Œç™»å‡ºæŒ‰éˆ• (åœ¨é ­éƒ¨æŒ‰éˆ•çš„ä¸‹æ‹‰èœå–®) */
        #user-dropdown {
            display: none;
            position: absolute;
            top: 60px; /* Adjust as needed based on button height */
            right: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            z-index: 100;
            min-width: 150px;
            text-align: center;
        }

        #user-dropdown p {
            padding: 10px 15px;
            margin: 0;
            color: #776e65;
            font-weight: bold;
            border-bottom: 1px solid #eee;
        }

        #user-dropdown button {
            width: 100%;
            padding: 10px 15px;
            background-color: #d9534f;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        #user-dropdown button:hover {
            background-color: #c9302c;
        }

        #user-dropdown #account-settings-btn-dropdown {
            background-color: #8f7a66; /* Match main auth button style */
            border-radius: 0;
            border-bottom: 1px solid #eee;
        }
        #user-dropdown #account-settings-btn-dropdown:hover {
            background-color: #9f8b7b;
        }

        /* æ’è¡Œæ¦œå½ˆçª— */
        #leaderboard-modal .modal-content {
            max-width: 600px;
        }

        #leaderboard-modal table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #leaderboard-modal th, #leaderboard-modal td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            color: #776e65;
        }

        #leaderboard-modal th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        #leaderboard-modal .sort-buttons button {
            background-color: #bbada0;
            margin: 5px;
            padding: 8px 15px;
            font-size: 16px;
            color: #f9f6f2;
            border-radius: 5px;
        }

        #leaderboard-modal .sort-buttons button:hover {
            background-color: #cdc1b4;
        }

        #user-uid-display {
            margin-top: 20px;
            font-size: 14px;
            color: #888;
        }

        /* ä¸»é è¨­å®šæŒ‰éˆ• */
        #main-settings-button {
            padding: 15px 30px;
            font-size: 24px;
            font-weight: bold;
            color: #f9f6f2;
            background-color: #8f7a66;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            width: 200px;
            transition: background-color 0.3s;
        }
        #main-settings-button:hover {
            background-color: #9f8b7b;
        }

        /* Account Settings Modal Specific Styles */
        #account-settings-modal .modal-content {
            max-width: 450px;
        }

        #account-settings-modal label {
            display: block;
            text-align: left;
            margin-bottom: 5px;
            font-weight: bold;
            color: #776e65;
            font-size: 16px;
        }

        #account-settings-modal input, #account-settings-modal select {
            width: calc(100% - 24px); /* Adjust for padding and border */
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        #account-settings-modal button {
            margin-top: 10px;
        }

        /* Main Settings Modal Specific Styles */
        #main-settings-modal .modal-content {
            max-width: 400px;
        }
        #main-settings-modal .settings-option {
            margin-bottom: 20px;
        }
        #main-settings-modal .settings-option label {
            display: block;
            text-align: left;
            margin-bottom: 10px;
            font-weight: bold;
            color: #776e65;
            font-size: 18px;
        }
        #main-settings-modal .settings-option select {
            width: 100%;
        }

    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>

</head>
<body>
    <h1>2048 éŠæˆ²</h1>

    <div id="auth-header-button">
        <span id="auth-display-name">ç™»å…¥ / è¨»å†Š</span>
    </div>
    <div id="user-dropdown">
        <p>æ­¡è¿ï¼Œ<span id="user-email-dropdown"></span>ï¼</p>
        <button id="account-settings-btn-dropdown">å¸³æˆ¶è¨­å®š</button>
        <button id="logout-btn-dropdown">ç™»å‡º</button>
    </div>


    <div id="game-info-area" style="display: none;">
        <div id="score-board">åˆ†æ•¸: <span id="score">0</span></div>
        <div id="high-score-board">æœ€é«˜åˆ†: <span id="high-score">0</span></div>
        <div id="timer-display-container">æ™‚é–“: <span id="time">00:00</span></div>
        <button id="restart-button-always" onclick="restartGame()">é‡æ–°é–‹å§‹</button>
    </div>

    <div id="game-board">
    </div>

    <div id="game-over">
        <p id="game-over-message"></p>
        <button onclick="restartGame()">é‡æ–°é–‹å§‹</button>
    </div>

    <div id="difficulty-selection">
        <h2>é¸æ“‡æ¿é¢å°ºå¯¸</h2>
        <button onclick="setBoardSize(4)">4 x 4 (æ¨™æº–)</button>
        <button onclick="setBoardSize(5)">5 x 5</button>
        <button onclick="setBoardSize(6)">6 x 6</button>
        <button onclick="setBoardSize(7)">7 x 7</button>
        <button onclick="startTutorial()">æ•™å­¸æ¨¡å¼</button>
        <button id="leaderboard-button">æ’è¡Œæ¦œ</button>
        <button id="main-settings-button">è¨­å®š</button>
    </div>

    <button id="home-button" style="display: none;" onclick="goHome()">å›åˆ°ä¸»é </button>

    <button id="pause-button" style="display: none;">æš«åœ</button>

    <div id="roast-mode-toggle-container">
        <label for="roast-mode-checkbox">å˜´ç ²æ¨¡å¼</label>
        <label class="switch">
            <input type="checkbox" id="roast-mode-checkbox">
            <span class="slider"></span>
        </label>
    </div>

    <button id="main-feedback-button">æ„è¦‹åé¥‹</button>
    <div id="feedback-options">
        <button id="feedback-web">ç”¨ç¶²é ç‰ˆ Gmail</button>
        <button id="feedback-app">ç”¨éƒµä»¶æ‡‰ç”¨ç¨‹å¼</button>
    </div>

    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="auth-main-options">
                <h2>å¸³æˆ¶æ“ä½œ</h2>
                <div class="auth-options">
                    <button id="show-login-form">ç™»å…¥</button>
                    <button id="show-register-form">è¨»å†Š</button>
                    <button id="phone-auth-button">é›»è©±ç™»å…¥ / è¨»å†Š</button>
                    <button id="google-signin-btn-modal">ä½¿ç”¨ Google ç™»å…¥</button>
                </div>
            </div>

            <div id="login-form-modal" class="auth-form-container">
                <h2>ç™»å…¥</h2>
                <input type="email" id="login-email-input" placeholder="é›»å­éƒµä»¶" required>
                <input type="password" id="login-password-input" placeholder="å¯†ç¢¼" required>
                <button id="login-btn-modal">ç™»å…¥</button>
                <button class="back-to-main-auth">è¿”å›</button>
            </div>

            <div id="register-form-modal" class="auth-form-container">
                <h2>è¨»å†Š</h2>
                <input type="email" id="register-email-input" placeholder="é›»å­éƒµä»¶" required>
                <input type="password" id="register-password-input" placeholder="å¯†ç¢¼" required>
                <input type="password" id="register-confirm-password-input" placeholder="å†æ¬¡ç¢ºèªå¯†ç¢¼" required>
                <button id="register-btn-modal">è¨»å†Š</button>
                <button class="back-to-main-auth">è¿”å›</button>
            </div>

            <div id="phone-auth-modal" class="auth-form-container">
                <h2>é›»è©±ç™»å…¥ / è¨»å†Š</h2>
                <div id="recaptcha-container"></div>
                <input type="tel" id="phone-number-input" placeholder="è¼¸å…¥é›»è©±è™Ÿç¢¼ (+åœ‹ç¢¼)" required>
                <button id="send-otp-button">ç™¼é€é©—è­‰ç¢¼</button>
                <input type="text" id="otp-input" placeholder="è¼¸å…¥é©—è­‰ç¢¼" style="display:none;">
                <button id="verify-otp-button" style="display:none;">é©—è­‰</button>
                <input type="text" id="phone-display-name-input" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±" style="display:none;">
                <button id="set-phone-display-name-button" style="display:none;">è¨­å®šæš±ç¨±</button>
                <button class="back-to-main-auth">è¿”å›</button>
            </div>
        </div>
    </div>

    <div id="leaderboard-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>æ’è¡Œæ¦œ</h2>
            <div class="sort-buttons">
                <button id="sort-by-score">ä¾åˆ†æ•¸æ’å(åƒ…é”åˆ°2048æ‰æœƒåˆ—å…¥)</button>
                <button id="sort-by-time">ä¾æ™‚é–“æ’å(åƒ…é”åˆ°2048æ‰æœƒåˆ—å…¥)</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>ä½¿ç”¨è€…</th>
                        <th>åœ‹å®¶</th> <th>åˆ†æ•¸</th>
                        <th>æ™‚é–“</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="account-settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>å¸³æˆ¶è¨­å®š</h2>
            <label for="settings-display-name">æš±ç¨±:</label>
            <input type="text" id="settings-display-name" placeholder="è¼¸å…¥æ–°æš±ç¨±">

            <label for="settings-country">åœ‹å®¶:</label>
            <select id="settings-country">
                <option value="Taiwan">å°ç£</option>
                <option value="USA">ç¾åœ‹</option>
                <option value="Japan">æ—¥æœ¬</option>
                <option value="Other">å…¶ä»–</option>
            </select>
            <button id="save-account-settings-button">å„²å­˜è¨­å®š</button>
            <button class="back-to-main-auth">è¿”å›</button>
        </div>
    </div>

    <div id="main-settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>è¨­å®š</h2>
            <div class="settings-option">
                <label for="language-select">èªè¨€:</label>
                <select id="language-select">
                    <option value="zh-Hant">ç¹é«”ä¸­æ–‡</option>
                    <option value="en">English</option>
                </select>
            </div>
            <button class="back-to-main-auth">è¿”å›</button>
        </div>
    </div>

    <div id="user-uid-display">
        </div>


    <script>
        // Firebase Configuration - REPLACE WITH YOUR ACTUAL FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCdbyuB8P-YxX5VHqjsO2w95NfaVkzOTLw",
            authDomain: "project-2518324333403573393.firebaseapp.com",
            projectId: "project-2518324333403573393",
            storageBucket: "project-2518324333403573393.firebasestorage.app",
            messagingSenderId: "1040297292453",
            appId: "1:1040297292453:web:6d933a3665aba6ea96934c"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database(); // Initialize Realtime Database

        /* å…¨åŸŸè®Šæ•¸ */
        let boardSize = 4; // éŠæˆ²æ¿çš„å°ºå¯¸ (ä¾‹å¦‚ 4x4, 5x5)
        let board = []; // éŠæˆ²æ¿çš„äºŒç¶­é™£åˆ—ï¼Œå„²å­˜æ–¹å¡Šæ•¸å€¼
        let score = 0; // ç•¶å‰åˆ†æ•¸
        let highScore = 0; // æ–°å¢ï¼šæœ€é«˜åˆ†æ•¸
        let isTutorial = false; // æ˜¯å¦è™•æ–¼æ•™å­¸æ¨¡å¼
        let tutorialStep = 0; // æ•™å­¸æ¨¡å¼çš„æ­¥é©Ÿ
        let gameActive = false; // éŠæˆ²æ˜¯å¦æ´»èº (å¯ä»¥æ»‘å‹•)
        let timerId = null; // è¨ˆæ™‚å™¨ ID
        let totalSeconds = 0; // ç¸½ç§’æ•¸
        let isPaused = false; // éŠæˆ²æ˜¯å¦æš«åœ
        let currentUser = null; // æ–°å¢ï¼šå„²å­˜ç•¶å‰ç™»å…¥çš„ç”¨æˆ¶
        let currentLanguage = 'zh-Hant'; // Default language

        // Phone Auth Globals
        let firebaseRecaptchaVerifier;
        let confirmationResult;

        // å˜´ç ²æ¨¡å¼é–‹é—œç‹€æ…‹ï¼Œå¾ localStorage è®€å–æˆ–é è¨­é–‹å•Ÿ
        let isRoastModeEnabled = localStorage.getItem('roastMode') === 'disabled' ? false : true;

        // æ•™å­¸æ¨¡å¼çš„æ­¥é©Ÿå®šç¾©
        const tutorialSteps = [
            {
                message: 'æ­¡è¿ä¾†åˆ°2048æ•™å­¸ï¼é¦–å…ˆï¼Œè©¦è‘—å‘å·¦æ»‘ï¼Œè®“å…©å€‹ 2 åˆä½µæˆ 4ï¼',
                board: [
                    [2, 2, 0, 0],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0],
                ],
                expectedMove: 'left' // æ­¤æ­¥é©Ÿé æœŸçš„ç§»å‹•æ–¹å‘
            },
            {
                message: 'å¤ªæ£’äº†ï¼ç¾åœ¨ï¼Œè«‹å‘ä¸Šæ»‘ï¼Œæº–å‚™è¿æ¥ä¸‹ä¸€å€‹åˆä½µï¼',
                board: [
                    [0, 0, 0, 0],
                    [4, 0, 0, 0],
                    [4, 0, 0, 0],
                    [0, 0, 0, 0],
                ],
                expectedMove: 'up' // æ­¤æ­¥é©Ÿé æœŸçš„ç§»å‹•æ–¹å‘
            },
            {
                message: 'å®Œç¾æ”¶å·¥ ğŸ‰ ä½ å·²ç¶“å­¸æœƒ2048æ€éº¼ç©äº†ï¼',
                board: [
                    [8, 0, 0, 0],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0],
                ],
                expectedMove: null // æ²’æœ‰é æœŸå‹•ä½œï¼Œè¡¨ç¤ºæ•™å­¸æ¨¡å¼çµæŸ
            },
            {
                message: 'éŠæˆ²é–‹å§‹å¾Œï¼Œå·¦ä¸Šè§’æœƒé¡¯ç¤ºä½ çš„åˆ†æ•¸ï¼Œä¸‹æ–¹å‰‡æœƒé¡¯ç¤ºä½ æ‰€èŠ±è²»çš„æ™‚é–“å–”ï¼å¥½å¥½äº«å—éŠæˆ²å§ï¼',
                board: [ // å¯ä»¥ä½¿ç”¨ä¸€å€‹åŸºç¤æ¿é¢
                    [2, 0, 0, 0],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0],
                ],
                expectedMove: null,
                isInfoStep: true // æ¨™è¨˜ç‚ºè³‡è¨Šæ­¥é©Ÿ
            }
        ];

        /* å–å¾— DOM å…ƒç´  */
        const gameBoard = document.getElementById('game-board');
        const gameInfoArea = document.getElementById('game-info-area'); // æ›´æ–° ID
        const scoreBoard = document.getElementById('score-board');
        const scoreDisplay = document.getElementById('score');
        const highScoreBoard = document.getElementById('high-score-board');
        const highScoreDisplay = document.getElementById('high-score');
        const timerDisplayContainer = document.getElementById('timer-display-container');
        const timeDisplay = document.getElementById('time');
        const gameOverDisplay = document.getElementById('game-over');
        const gameOverMessage = document.getElementById('game-over-message');
        const difficultySelection = document.getElementById('difficulty-selection');
        const homeButton = document.getElementById('home-button');
        const restartButtonAlways = document.getElementById('restart-button-always'); // æ–°å¢ï¼šéš¨æ™‚é‡æ–°é–‹å§‹æŒ‰éˆ•

        // æ„è¦‹åé¥‹ç›¸é—œ DOM å…ƒç´ 
        const mainFeedbackButton = document.getElementById('main-feedback-button');
        const feedbackOptions = document.getElementById('feedback-options');
        const feedbackWebButton = document.getElementById('feedback-web');
        const feedbackAppButton = document.getElementById('feedback-app');

        // æš«åœæŒ‰éˆ• DOM å…ƒç´ 
        const pauseButton = document.getElementById('pause-button');

        // å˜´ç ²é–‹é—œ DOM å…ƒç´ 
        const roastModeToggleContainer = document.getElementById('roast-mode-toggle-container');
        const roastModeCheckbox = document.getElementById('roast-mode-checkbox');

        // Firebase Auth Modal Elements (æ–°åŠ å…¥æˆ–ä¿®æ”¹çš„ DOM å…ƒç´ )
        const authHeaderButton = document.getElementById('auth-header-button');
        const authDisplayName = document.getElementById('auth-display-name');
        const userDropdown = document.getElementById('user-dropdown');
        const userEmailDropdown = document.getElementById('user-email-dropdown');
        const accountSettingsBtnDropdown = document.getElementById('account-settings-btn-dropdown'); // æ–°å¢å¸³æˆ¶è¨­å®šæŒ‰éˆ•
        const logoutBtnDropdown = document.getElementById('logout-btn-dropdown');

        const authModal = document.getElementById('auth-modal');
        const closeModalButton = authModal.querySelector('.close-button');
        const authMainOptions = document.getElementById('auth-main-options');
        const showLoginFormBtn = document.getElementById('show-login-form');
        const showRegisterFormBtn = document.getElementById('show-register-form');
        const googleSigninBtnModal = document.getElementById('google-signin-btn-modal'); // å½ˆçª—å…§çš„ Google ç™»å…¥æŒ‰éˆ•
        const phoneAuthButton = document.getElementById('phone-auth-button'); // æ–°å¢é›»è©±ç™»å…¥æŒ‰éˆ•

        const loginFormModal = document.getElementById('login-form-modal');
        const loginEmailInput = document.getElementById('login-email-input');
        const loginPasswordInput = document.getElementById('login-password-input');
        const loginBtnModal = document.getElementById('login-btn-modal');

        const registerFormModal = document.getElementById('register-form-modal');
        const registerEmailInput = document.getElementById('register-email-input');
        const registerPasswordInput = document.getElementById('register-password-input');
        const registerConfirmPasswordInput = document.getElementById('register-confirm-password-input');
        const registerBtnModal = document.getElementById('register-btn-modal');

        const phoneAuthModal = document.getElementById('phone-auth-modal'); // æ–°å¢é›»è©±èªè­‰æ¨¡æ…‹æ¡†
        const recaptchaContainer = document.getElementById('recaptcha-container');
        const phoneNumberInput = document.getElementById('phone-number-input');
        const sendOtpButton = document.getElementById('send-otp-button');
        const otpInput = document.getElementById('otp-input');
        const verifyOtpButton = document.getElementById('verify-otp-button');
        const phoneDisplayNameInput = document.getElementById('phone-display-name-input');
        const setPhoneDisplayNameButton = document.getElementById('set-phone-display-name-button');


        const backToMainAuthButtons = document.querySelectorAll('.back-to-main-auth');

        // æ’è¡Œæ¦œç›¸é—œ DOM å…ƒç´ 
        const leaderboardButton = document.getElementById('leaderboard-button');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const leaderboardTableBody = document.getElementById('leaderboard-table-body');
        const sortbyScoreButton = document.getElementById('sort-by-score');
        const sortByTimeButton = document.getElementById('sort-by-time');

        // ä½¿ç”¨è€… UID é¡¯ç¤º
        const userUidDisplay = document.getElementById('user-uid-display');

        // å¸³æˆ¶è¨­å®šç›¸é—œ DOM å…ƒç´ 
        const accountSettingsModal = document.getElementById('account-settings-modal');
        const settingsDisplayNameInput = document.getElementById('settings-display-name');
        const settingsCountrySelect = document.getElementById('settings-country');
        const saveAccountSettingsButton = document.getElementById('save-account-settings-button');

        // ä¸»é è¨­å®šç›¸é—œ DOM å…ƒç´ 
        const mainSettingsButton = document.getElementById('main-settings-button');
        const mainSettingsModal = document.getElementById('main-settings-modal');
        const languageSelect = document.getElementById('language-select');


        // --- åˆå§‹åŒ–å˜´ç ²é–‹é—œç‹€æ…‹ ---
        roastModeCheckbox.checked = isRoastModeEnabled;

        // --- æ„è¦‹åé¥‹å½ˆå‡ºé‚è¼¯ ---
        const emailAddress = "hsc0529.myself.tw@gmail.com";
        const subject = "2048éŠæˆ²æ„è¦‹åé¥‹";
        const body = "ï¼ˆè«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„æ„è¦‹æˆ–å»ºè­°ï¼‰";

        mainFeedbackButton.addEventListener('click', () => {
            feedbackOptions.style.display = feedbackOptions.style.display === 'flex' ? 'none' : 'flex';
        });

        feedbackWebButton.addEventListener('click', () => {
            window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${emailAddress}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
            feedbackOptions.style.display = 'none';
        });

        feedbackAppButton.addEventListener('click', () => {
            window.location.href = `mailto:${emailAddress}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            feedbackOptions.style.display = 'none';
        });

        // é»æ“Šé¸é …å¤–éƒ¨å€åŸŸæ™‚éš±è—é¸é …
        document.addEventListener('click', (event) => {
            if (!feedbackOptions.contains(event.target) && event.target !== mainFeedbackButton) {
                feedbackOptions.style.display = 'none';
            }
        });
        // --- æ„è¦‹åé¥‹å½ˆå‡ºé‚è¼¯ END ---

        // --- æš«åœ/ç¹¼çºŒåŠŸèƒ½é‚è¼¯ ---
        pauseButton.addEventListener('click', togglePause);

        function togglePause() {
            if (isPaused) {
                // å¾æš«åœæ¢å¾©
                isPaused = false;
                gameActive = true; // æ¢å¾©éŠæˆ²æ“ä½œ
                startTimer(); // æ¢å¾©è¨ˆæ™‚
                pauseButton.textContent = 'æš«åœ';
                pauseButton.classList.remove('paused');
                hideMessage(); // éš±è—å½ˆå‡ºæ¡† (åƒ…ç•¶æš«åœè¨Šæ¯è¢«é¡¯ç¤ºæ™‚)
            } else {
                // æš«åœéŠæˆ²
                isPaused = true;
                gameActive = false; // ç¦æ­¢éŠæˆ²æ“ä½œ
                stopTimer(); // åœæ­¢è¨ˆæ™‚
                pauseButton.textContent = 'ç¹¼çºŒ';
                pauseButton.classList.add('paused');
                showMessage('éŠæˆ²å·²æš«åœ', false); // é¡¯ç¤ºæš«åœè¨Šæ¯ï¼Œä¸é¡¯ç¤º Restart æŒ‰éˆ•
            }
        }
        // --- æš«åœ/ç¹¼çºŒåŠŸèƒ½é‚è¼¯ END ---

        // --- è¨ˆæ™‚å™¨åŠŸèƒ½é‚è¼¯ ---
        function formatTime(seconds) {
            if (seconds === null || seconds === undefined) return "--:--"; // Handle null/undefined time for leaderboard
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const formattedMinutes = String(minutes).padStart(2, '0');
            const formattedSeconds = String(remainingSeconds).padStart(2, '0');
            return `${formattedMinutes}:${formattedSeconds}`;
        }

        function startTimer() {
            if (timerId) {
                clearInterval(timerId);
            }
            timerId = setInterval(() => {
                totalSeconds++;
                timeDisplay.textContent = formatTime(totalSeconds);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerId);
            timerId = null;
        }

        function resetTimer() {
            stopTimer();
            totalSeconds = 0;
            timeDisplay.textContent = formatTime(totalSeconds);
        }
        // --- è¨ˆæ™‚å™¨åŠŸèƒ½é‚è¼¯ END ---

        // --- æœ€é«˜åˆ†ç´€éŒ„ç³»çµ±é‚è¼¯ (æ•´åˆ Firestore å’Œ localStorage) ---
        async function loadHighScore() {
            if (currentUser) {
                // å¾ Firestore è¼‰å…¥æœ€é«˜åˆ†
                try {
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    if (userDoc.exists) {
                        highScore = userDoc.data().highScore || 0;
                    } else {
                        // å¦‚æœæ˜¯æ–°ç”¨æˆ¶ï¼Œåˆå§‹åŒ– Firestore ç´€éŒ„
                        await db.collection('users').doc(currentUser.uid).set({
                            highScore: 0,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            country: "Taiwan" // Set default country for new users
                        }, { merge: true });
                        highScore = 0;
                    }
                } catch (error) {
                    console.error("è¼‰å…¥ Firestore æœ€é«˜åˆ†å¤±æ•—:", error);
                    highScore = 0; // è¼‰å…¥å¤±æ•—å‰‡é è¨­ç‚º0
                }
            } else {
                // å¾ localStorage è¼‰å…¥æœ€é«˜åˆ† (æœªç™»å…¥ç”¨æˆ¶)
                const storedHighScore = localStorage.getItem('2048_highScore');
                if (storedHighScore) {
                    highScore = parseInt(storedHighScore);
                } else {
                    highScore = 0;
                }
            }
            highScoreDisplay.textContent = highScore;
        }

        async function saveHighScore() {
            let scoreUpdated = false;
            if (score > highScore) {
                highScore = score;
                highScoreDisplay.textContent = highScore; // å³æ™‚æ›´æ–°é¡¯ç¤º
                scoreUpdated = true;
            }

            if (currentUser) {
                // å„²å­˜åˆ° Firestore
                try {
                    await db.collection('users').doc(currentUser.uid).set({
                        highScore: highScore,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true }); // ä½¿ç”¨ merge ä»¥å…è¦†è“‹å…¶ä»–ç”¨æˆ¶æ•¸æ“š
                    console.log("Firestore æœ€é«˜åˆ†å·²å„²å­˜:", highScore);
                } catch (error) {
                    console.error("å„²å­˜ Firestore æœ€é«˜åˆ†å¤±æ•—:", error);
                }
            } else if (scoreUpdated) {
                // å„²å­˜åˆ° localStorage
                localStorage.setItem('2048_highScore', highScore);
                console.log("localStorage æœ€é«˜åˆ†å·²å„²å­˜:", highScore);
            }
        }

        // --- Leaderboard functionality ---
        leaderboardButton.addEventListener('click', () => {
            showLeaderboard('score'); // Default sort by score
            leaderboardModal.style.display = 'flex';
        });

        leaderboardModal.querySelector('.close-button').addEventListener('click', () => {
            leaderboardModal.style.display = 'none';
        });

        sortbyScoreButton.addEventListener('click', () => showLeaderboard('score'));
        sortByTimeButton.addEventListener('click', () => showLeaderboard('time'));

        async function showLeaderboard(sortBy = 'score') {
            const leaderboardData = await fetchLeaderboardData(sortBy);
            renderLeaderboard(leaderboardData, sortBy);
        }

        async function fetchLeaderboardData(sortBy) {
            try {
                let query = db.collection('leaderboard');
                if (sortBy === 'score') {
                    query = query.orderBy('score', 'desc').limit(10);
                } else { // sortBy === 'time'
                    query = query.where('reached2048', '==', true).orderBy('timeInSeconds', 'asc').limit(10);
                }

                const snapshot = await query.get();
                const data = [];
                for (const doc of snapshot.docs) {
                    const entry = doc.data();
                    let userName = 'æœªçŸ¥ç©å®¶';
                    let userCountry = 'N/A';
                    // Try to get display name and country from Firestore 'users' collection
                    if (entry.userId) {
                        try {
                            const userDoc = await db.collection('users').doc(entry.userId).get();
                            if (userDoc.exists) {
                                userName = userDoc.data().displayName || userDoc.data().email || userDoc.data().phoneNumber || 'åŒ¿åç©å®¶';
                                userCountry = userDoc.data().country || 'N/A';
                            } else if (entry.userEmail) { // Fallback to email if user doc not found
                                userName = entry.userEmail.split('@')[0]; // Use part before @
                            }
                        } catch (error) {
                            console.warn("Failed to fetch user info for leaderboard:", error);
                            if (entry.userEmail) {
                                userName = entry.userEmail.split('@')[0];
                            }
                        }
                    } else if (entry.userEmail) {
                        userName = entry.userEmail.split('@')[0];
                    }

                    data.push({
                        id: doc.id,
                        user: userName,
                        country: userCountry,
                        score: entry.score,
                        time: entry.timeInSeconds, // raw seconds
                        reached2048: entry.reached2048
                    });
                }
                return data;
            } catch (error) {
                console.error("Error fetching leaderboard data:", error);
                return [];
            }
        }

        function renderLeaderboard(data, sortBy) {
            leaderboardTableBody.innerHTML = ''; // Clear existing
            if (data.length === 0) {
                leaderboardTableBody.innerHTML = '<tr><td colspan="5">ç›®å‰æ²’æœ‰æ’è¡Œæ¦œè³‡æ–™ã€‚</td></tr>'; // Adjusted colspan
                return;
            }

            data.forEach((entry, index) => {
                const row = leaderboardTableBody.insertRow();
                const rankCell = row.insertCell();
                const userCell = row.insertCell();
                const countryCell = row.insertCell(); // New country cell
                const scoreCell = row.insertCell();
                const timeCell = row.insertCell();

                rankCell.textContent = index + 1;
                userCell.textContent = entry.user;
                countryCell.textContent = entry.country; // Display country
                scoreCell.textContent = entry.score;
                timeCell.textContent = formatTime(entry.time);
            });
        }
        // --- Leaderboard functionality END ---


        /**
         * å•Ÿå‹•æ•™å­¸æ¨¡å¼ã€‚
         * è¨­ç½®æ•™å­¸æ¨¡å¼ç›¸é—œè®Šæ•¸ï¼Œéš±è—é›£åº¦é¸æ“‡ï¼Œé¡¯ç¤ºéŠæˆ²ä»‹é¢ï¼Œä¸¦åŠ è¼‰ç¬¬ä¸€æ­¥æ•™å­¸ã€‚
         */
        function startTutorial() {
            isTutorial = true;
            tutorialStep = 0;
            boardSize = 4; // æ•™å­¸æ¨¡å¼å›ºå®š 4x4
            hideAllGameElements(); // éš±è—æ‰€æœ‰éŠæˆ²ç›¸é—œå…ƒç´ 
            difficultySelection.style.display = 'none'; // éš±è—é›£åº¦é¸æ“‡
            roastModeToggleContainer.style.display = 'none'; // éš±è—å˜´ç ²é–‹é—œ
            authHeaderButton.style.display = 'none'; // æ•™å­¸æ¨¡å¼éš±è—å³ä¸Šè§’èªè­‰æŒ‰éˆ•
            userDropdown.style.display = 'none'; // ç¢ºä¿ä¸‹æ‹‰èœå–®éš±è—
            userUidDisplay.style.display = 'none'; // éš±è— UID é¡¯ç¤º
            mainSettingsButton.style.display = 'none'; // éš±è—ä¸»é è¨­å®šæŒ‰éˆ•

            // ç¢ºä¿åˆ†æ•¸æ¿å’Œè¨ˆæ™‚å™¨å®¹å™¨åœ¨æ•™å­¸æ¨¡å¼é¡¯ç¤º
            gameInfoArea.style.display = 'flex'; // é¡¯ç¤ºåˆ†æ•¸æ¿å®¹å™¨
            scoreBoard.style.display = 'block';
            highScoreBoard.style.display = 'block';
            timerDisplayContainer.style.display = 'block';
            restartButtonAlways.style.display = 'none'; // æ•™å­¸æ¨¡å¼ä¸‹ä¸é¡¯ç¤ºé€™å€‹é‡æ–°é–‹å§‹æŒ‰éˆ•

            gameBoard.style.display = 'grid'; // é¡¯ç¤ºéŠæˆ²æ¿
            homeButton.style.display = 'block'; // é¡¯ç¤ºå›åˆ°ä¸»é æŒ‰éˆ•
            pauseButton.style.display = 'block'; // é¡¯ç¤ºæš«åœæŒ‰éˆ•

            // è¨­å®š CSS è®Šæ•¸ä¾†èª¿æ•´æ–¹å¡Šå¤§å°å’Œé–“è·
            setBoardCSSVariables(boardSize);

            initGame(); // å…ˆåˆå§‹åŒ–éŠæˆ²æ¿çš„ç©ºæ–¹å¡Š (é€™ä¹Ÿæœƒå‘¼å« hideMessage())
            resetTimer(); // é‡ç½®è¨ˆæ™‚å™¨ï¼Œä½†ä¸å•Ÿå‹• (ç”± loadTutorialStep æ±ºå®šä½•æ™‚å•Ÿå‹•)
            loadTutorialStep(); // åŠ è¼‰æ•™å­¸æ¨¡å¼çš„ç¬¬ä¸€æ­¥
            isPaused = false; // ç¢ºä¿ä¸æ˜¯æš«åœç‹€æ…‹
            pauseButton.textContent = 'æš«åœ';
            pauseButton.classList.remove('paused');
        }

        /**
         * åŠ è¼‰æ•™å­¸æ¨¡å¼çš„æŒ‡å®šæ­¥é©Ÿã€‚
         * æ ¹æ“š tutorialStep è¼‰å…¥å°æ‡‰çš„éŠæˆ²æ¿ç‹€æ…‹å’Œè¨Šæ¯ã€‚
         */
        function loadTutorialStep() {
            const step = tutorialSteps[tutorialStep];

            if (step.isInfoStep) {
                // è³‡è¨Šæ­¥é©Ÿï¼šé¡¯ç¤ºè¨Šæ¯ï¼Œä¸æ”¹è®Šæ¿é¢ï¼Œä¸æ¥å—æ»‘å‹•ï¼Œè‡ªå‹•è·³è½‰
                board = JSON.parse(JSON.stringify(step.board)); // è³‡è¨Šæ­¥é©Ÿä¹Ÿæ›´æ–°æ¿é¢ï¼Œè®“ç©å®¶çœ‹åˆ°ç¯„ä¾‹
                updateBoard(); // æ›´æ–°éŠæˆ²æ¿çš„è¦–è¦ºç‹€æ…‹

                showMessage(step.message, false);
                gameActive = false; // è³‡è¨Šæ­¥é©Ÿæ™‚ç¦æ­¢æ»‘å‹•
                stopTimer(); // è³‡è¨Šæ­¥é©Ÿæ™‚åœæ­¢è¨ˆæ™‚
                pauseButton.style.display = 'none'; // è³‡è¨Šæ­¥é©Ÿæ™‚æš«åœæŒ‰éˆ•éš±è—

                setTimeout(() => {
                    hideMessage(); // è³‡è¨Šæ­¥é©Ÿçš„è¨Šæ¯æœƒè‡ªå‹•éš±è—
                    tutorialStep++;
                    if (tutorialStep < tutorialSteps.length) {
                        loadTutorialStep();
                    } else {
                        gameActive = false;
                        stopTimer();
                        goHome();
                        alert(getTranslation('tutorial_complete_message')); // ä½¿ç”¨å¤šèªè¨€è¨Šæ¯
                    }
                }, 4000); // 4 ç§’å¾Œè‡ªå‹•è·³è½‰
            } else {
                // äº’å‹•æ•™å­¸æ­¥é©Ÿï¼šé¡¯ç¤ºè¨Šæ¯ï¼Œè¼‰å…¥æ¿é¢ï¼Œå…è¨±æ»‘å‹•ï¼Œç­‰å¾…ç©å®¶æ“ä½œ
                board = JSON.parse(JSON.stringify(step.board));
                score = 0;
                updateScore(0);
                updateBoard();
                showMessage(step.message, false); // æ•™å­¸å½ˆçª—ä¸é¡¯ç¤ºã€Œé‡æ–°é–‹å§‹ã€æŒ‰éˆ•
                gameActive = true; // å…è¨±æ»‘å‹•

                // æ•™å­¸æ¨¡å¼ä¸­ï¼Œåªæœ‰åœ¨å¯¦éš›éŠæˆ²æ­¥é©Ÿæ‰å•Ÿå‹•è¨ˆæ™‚
                // ä¿®æ­£ï¼šé¦–æ¬¡é€²å…¥æ“ä½œæ­¥é©Ÿæ‰å•Ÿå‹•è¨ˆæ™‚ï¼Œå¾ŒçºŒäº’å‹•æ­¥é©Ÿä¿æŒè¨ˆæ™‚
                if (tutorialStep === 0 && !timerId) { // å¦‚æœæ˜¯ç¬¬ä¸€å€‹äº’å‹•æ­¥é©Ÿä¸”è¨ˆæ™‚å™¨æœªå•Ÿå‹•
                   startTimer();
                } else if (!timerId && !isPaused) { // å¦‚æœè¨ˆæ™‚å™¨æ²’åœ¨è·‘ä¸”ä¸æ˜¯æš«åœç‹€æ…‹ï¼Œå°±å•Ÿå‹•
                    startTimer();
                }

                pauseButton.style.display = 'block'; // é¡¯ç¤ºæš«åœæŒ‰éˆ•
            }
        }

        /**
         * é¡¯ç¤ºéŠæˆ²çµæŸæˆ–å‹åˆ©è¨Šæ¯ã€‚
         * @param {string} msg - è¦é¡¯ç¤ºçš„è¨Šæ¯ã€‚
         * @param {boolean} showRestartButton - æ˜¯å¦é¡¯ç¤º Restart æŒ‰éˆ•ã€‚
         * @param {boolean} persist - æ˜¯å¦æŒçºŒé¡¯ç¤ºç›´åˆ°é»æ“Šï¼Œæ­¤åƒæ•¸å°‡æ§åˆ¶æ˜¯å¦åœ¨é¡¯ç¤ºå¾Œè‡ªå‹•éš±è—ã€‚
         */
        function showMessage(msg, showRestartButton = true) {
            gameOverDisplay.style.display = 'flex';
            gameOverDisplay.offsetWidth; // å¼·åˆ¶é‡ç¹ª
            gameOverDisplay.classList.add('show');
            gameOverMessage.textContent = msg;
            if (showRestartButton) {
                gameOverDisplay.querySelector('button').style.display = 'inline-block';
            } else {
                // æ•™å­¸æ¨¡å¼æˆ–æš«åœè¨Šæ¯ä¸é¡¯ç¤ºå½ˆçª—å…§çš„é‡æ–°é–‹å§‹æŒ‰éˆ•
                gameOverDisplay.querySelector('button').style.display = 'none';
            }
        }

        /**
         * éš±è—éŠæˆ²çµæŸæˆ–å‹åˆ©è¨Šæ¯ã€‚
         */
        function hideMessage() {
            gameOverDisplay.classList.remove('show');
            // åœ¨å‹•ç•«çµæŸå¾ŒçœŸæ­£éš±è—å…ƒç´ ï¼Œä½¿ç”¨ once é¿å…é‡è¤‡ç›£è½
            gameOverDisplay.addEventListener('transitionend', function handler() {
                if (!gameOverDisplay.classList.contains('show')) { // ç¢ºä¿æ˜¯æ·¡å‡ºå®Œæˆæ™‚æ‰éš±è—
                    gameOverDisplay.style.display = 'none';
                }
                gameOverDisplay.removeEventListener('transitionend', handler);
            }, { once: true });
        }


        /**
         * è¨­ç½®éŠæˆ²æ¿å°ºå¯¸ä¸¦é–‹å§‹éŠæˆ²ã€‚
         * @param {number} size - éŠæˆ²æ¿çš„å°ºå¯¸ (ä¾‹å¦‚ 4, 5, 6, 7)ã€‚
         */
        function setBoardSize(size) {
            boardSize = size;
            isTutorial = false; // é€€å‡ºæ•™å­¸æ¨¡å¼
            hideAllGameElements(); // éš±è—æ‰€æœ‰éŠæˆ²ç›¸é—œå…ƒç´ 
            difficultySelection.style.display = 'none'; // éš±è—é›£åº¦é¸æ“‡
            roastModeToggleContainer.style.display = 'none'; // éš±è—å˜´ç ²é–‹é—œ
            authHeaderButton.style.display = 'flex'; // é¡¯ç¤ºå³ä¸Šè§’èªè­‰æŒ‰éˆ•
            userUidDisplay.style.display = 'block'; // é¡¯ç¤º UID é¡¯ç¤º
            mainSettingsButton.style.display = 'none'; // éŠæˆ²é–‹å§‹å¾Œéš±è—ä¸»é è¨­å®šæŒ‰éˆ•

            // ç¢ºä¿åˆ†æ•¸æ¿å’Œè¨ˆæ™‚å™¨å®¹å™¨åœ¨éŠæˆ²æ¨¡å¼é¡¯ç¤º
            gameInfoArea.style.display = 'flex'; // é¡¯ç¤ºåˆ†æ•¸æ¿å®¹å™¨ (æ›´åç‚º game-info-area)
            scoreBoard.style.display = 'block';
            highScoreBoard.style.display = 'block';
            timerDisplayContainer.style.display = 'block';
            restartButtonAlways.style.display = 'block'; // ä¸€èˆ¬éŠæˆ²æ¨¡å¼ä¸‹é¡¯ç¤ºéš¨æ™‚é‡æ–°é–‹å§‹æŒ‰éˆ•

            gameBoard.style.display = 'grid'; // é¡¯ç¤ºéŠæˆ²æ¿
            homeButton.style.display = 'block'; // é¡¯ç¤ºå›åˆ°ä¸»é æŒ‰éˆ•
            pauseButton.style.display = 'block'; // é¡¯ç¤ºæš«åœæŒ‰éˆ•

            // é—œéµä¿®æ­£ï¼šå‹•æ…‹è¨­å®š CSS è®Šæ•¸ä»¥é©æ‡‰ä¸åŒå°ºå¯¸çš„æ¿é¢
            setBoardCSSVariables(boardSize);

            initGame(); // åˆå§‹åŒ–éŠæˆ²
            resetTimer(); // é‡ç½®è¨ˆæ™‚å™¨
            startTimer(); // é–‹å§‹è¨ˆæ™‚
            gameActive = true; // éŠæˆ²é–‹å§‹ï¼Œå¯ä»¥æ»‘å‹•
            isPaused = false; // ç¢ºä¿ä¸æ˜¯æš«åœç‹€æ…‹
            pauseButton.textContent = getTranslation('pause'); // ä½¿ç”¨å¤šèªè¨€
            pauseButton.classList.remove('paused');
        }

        /**
         * å‹•æ…‹è¨­å®šéŠæˆ²æ¿ç›¸é—œçš„ CSS è®Šæ•¸ã€‚
         * @param {number} size - éŠæˆ²æ¿çš„å°ºå¯¸ã€‚
         */
        function setBoardCSSVariables(size) {
            gameBoard.style.setProperty('--board-size', size);
            // æ ¹æ“šè¢å¹•å¯¬åº¦èª¿æ•´æ–¹å¡Šå¤§å°ï¼Œä½¿å…¶åœ¨ä¸åŒè¨­å‚™ä¸Šé¡¯ç¤ºè‰¯å¥½
            // 40px æ˜¯ body çš„å·¦å³ padding ç¸½å’Œ (20px + 20px)
            // var(--grid-gap) * (boardSize + 1) æ˜¯æ‰€æœ‰é–“è·çš„ç¸½å’Œ
            const tileCalcSize = `calc((100vw - 40px - (var(--grid-gap) * ${size + 1})) / ${size})`;
            gameBoard.style.setProperty('--tile-size', `min(100px, ${tileCalcSize})`);
            gameBoard.style.setProperty('--grid-gap', '10px'); // ä¿æŒé–“è·ç‚º 10px
            gameBoard.style.gridTemplateColumns = `repeat(${size}, var(--tile-size))`;
        }

        /**
         * åˆå§‹åŒ–éŠæˆ²ã€‚
         * é‡ç½®åˆ†æ•¸ã€éŠæˆ²æ¿ï¼Œä¸¦ç”Ÿæˆå…©å€‹åˆå§‹æ–¹å¡Šã€‚
         */
        async function initGame() {
            score = 0;
            updateScore(0);
            hideMessage(); // éš±è—éŠæˆ²çµæŸç•«é¢ (å¦‚æœæœ‰é¡¯ç¤ºçš„è©±)
            gameActive = true; // éŠæˆ²é–‹å§‹ï¼Œè¨­å®šç‚ºæ´»èºç‹€æ…‹
            isPaused = false;
            pauseButton.textContent = getTranslation('pause'); // ä½¿ç”¨å¤šèªè¨€
            pauseButton.classList.remove('paused');

            await loadHighScore(); // åœ¨åˆå§‹åŒ–éŠæˆ²æ™‚è¼‰å…¥æœ€é«˜åˆ†

            board = Array.from({ length: boardSize }, () => Array(boardSize).fill(0));
            gameBoard.innerHTML = '';
            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    tile.dataset.row = row;
                    tile.dataset.col = col;
                    gameBoard.appendChild(tile);
                }
            }
            if (!isTutorial) {
                addRandomTile();
                addRandomTile();
            }
            updateBoard();
        }

        /**
         * åœ¨éš¨æ©Ÿçš„ç©ºä½æ·»åŠ ä¸€å€‹æ–°çš„æ–¹å¡Š (2 æˆ– 4)ã€‚
         */
        function addRandomTile() {
            const emptyTiles = [];
            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    if (board[row][col] === 0) {
                        emptyTiles.push({ row, col });
                    }
                }
            }
            if (emptyTiles.length > 0) {
                const { row, col } = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
                board[row][col] = Math.random() < 0.9 ? 2 : 4;
            }
        }

        /**
         * æ›´æ–°éŠæˆ²æ¿çš„è¦–è¦ºç‹€æ…‹ (HTML)ã€‚
         * æ ¹æ“š board é™£åˆ—çš„æ•¸å€¼æ›´æ–°æ¯å€‹æ–¹å¡Šçš„å…§å®¹å’Œæ¨£å¼ã€‚
         */
        function updateBoard() {
            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    const tile = document.querySelector(`.tile[data-row='${row}'][data-col='${col}']`);
                    const value = board[row][col];
                    tile.textContent = value === 0 ? '' : value;
                    tile.dataset.value = value;
                    if (tile.classList.contains('merge')) {
                        tile.classList.remove('merge');
                    }
                }
            }
        }

        /**
         * æ›´æ–°åˆ†æ•¸ã€‚
         * @param {number} points - è¦å¢åŠ çš„åˆ†æ•¸ã€‚
         */
        function updateScore(points) {
            score += points;
            scoreDisplay.textContent = score;
        }

        /**
         * å°‡ä¸€è¡Œ (æˆ–åˆ—) ä¸­çš„éé›¶æ•¸å­—æ»‘å‹•åˆ°ä¸€å´ï¼Œä¸¦ç”¨é›¶å¡«å……ç©ºä½ã€‚
         * @param {Array<number>} line - è¦è™•ç†çš„ä¸€è¡Œæˆ–ä¸€åˆ—æ•¸å­—ã€‚
         * @returns {Array<number>} - æ»‘å‹•å¾Œçš„æ•¸å­—é™£åˆ—ã€‚
         */
        function slide(line) {
            const filtered = line.filter(val => val !== 0);
            const zeros = Array(line.length - filtered.length).fill(0);
            return [...filtered, ...zeros];
        }

        /**
         * åˆä½µä¸€è¡Œ (æˆ–åˆ—) ä¸­ç›¸é„°ä¸”ç›¸åŒæ•¸å€¼çš„æ–¹å¡Šã€‚
         * @param {Array<number>} line - è¦è™•ç†çš„ä¸€è¡Œæˆ–ä¸€åˆ—æ•¸å­—ã€‚
         * @returns {Array<number>} - åˆä½µå¾Œçš„æ•¸å­—é™£åˆ—ã€‚
         */
        function combine(line) {
            for (let i = 0; i < line.length - 1; i++) {
                if (line[i] !== 0 && line[i] === line[i + 1]) {
                    line[i] *= 2;
                    updateScore(line[i]);
                    line[i + 1] = 0;
                }
            }
            return line;
        }

        /**
         * è™•ç†éŠæˆ²æ¿çš„ç§»å‹•é‚è¼¯ã€‚
         * æ ¹æ“šæŒ‡å®šæ–¹å‘æ»‘å‹•å’Œåˆä½µæ–¹å¡Šï¼Œä¸¦åœ¨ç§»å‹•å¾Œæ·»åŠ æ–°æ–¹å¡Šï¼ˆéæ•™å­¸æ¨¡å¼ï¼‰ã€‚
         * @param {string} direction - ç§»å‹•æ–¹å‘ ('left', 'right', 'up', 'down')ã€‚
         */
        async function move(direction) {
            if (!gameActive || isPaused) {
                return;
            }

            if (isTutorial) {
                const step = tutorialSteps[tutorialStep];
                if (step.expectedMove && direction !== step.expectedMove) {
                    alert(getTranslation('tutorial_wrong_move_alert', { direction: getTranslation(step.expectedMove) }));
                    return;
                }
            }

            let moved = false;
            const originalBoard = JSON.parse(JSON.stringify(board));

            for (let i = 0; i < boardSize; i++) {
                let line;
                if (direction === 'left' || direction === 'right') {
                    line = [...board[i]];
                    if (direction === 'right') line.reverse();

                    line = combine(slide(line));
                    if (direction === 'right') line.reverse();
                    board[i] = line;
                } else {
                    line = board.map(r => r[i]);
                    if (direction === 'down') line.reverse();

                    line = combine(slide(line));
                    if (direction === 'down') line.reverse();
                    for (let j = 0; j < boardSize; j++) {
                        board[j][i] = line[j];
                    }
                }
            }

            for(let r = 0; r < boardSize; r++) {
                for(let c = 0; c < boardSize; c++) {
                    if (originalBoard[r][c] !== board[r][c]) {
                        moved = true;
                        break;
                    }
                }
                if (moved) break;
            }

            if (moved) {
                if (isTutorial) {
                    updateBoard();
                    hideMessage(); // ç©å®¶æ“ä½œæ­£ç¢ºå¾Œéš±è—æ•™å­¸æç¤º
                    tutorialStep++;
                    if (tutorialStep < tutorialSteps.length) {
                        setTimeout(loadTutorialStep, 500); // ç¨å¾®å»¶é²å¾Œè¼‰å…¥ä¸‹ä¸€æ­¥
                    } else {
                        gameActive = false;
                        stopTimer();
                        goHome();
                        alert(getTranslation('tutorial_complete_message'));
                    }
                } else {
                    addRandomTile();
                    updateBoard();

                    if (checkWin()) {
                        gameActive = false;
                        stopTimer();
                        await saveHighScore(); // Save highest score
                        await saveLeaderboardEntry(score, totalSeconds, true); // Save to leaderboard if 2048 is reached
                        displayWinMessage(); // é¡¯ç¤ºå‹åˆ©è¨Šæ¯
                    } else if (isGameOver()) {
                        gameActive = false;
                        stopTimer();
                        await saveHighScore(); // Save highest score
                        await saveLeaderboardEntry(score, totalSeconds, false); // Save to leaderboard, indicate 2048 not reached
                        displayGameOverMessage(); // é¡¯ç¤º Game Over è¨Šæ¯
                    }
                }
            }
        }

        async function saveLeaderboardEntry(finalScore, finalTime, reached2048) {
            if (currentUser) {
                try {
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    const userData = userDoc.exists ? userDoc.data() : {};
                    const userCountry = userData.country || 'N/A'; // Get country from user data

                    await db.collection('leaderboard').add({
                        userId: currentUser.uid,
                        userEmail: currentUser.email || null, // Can be null for phone auth if no email is set
                        userName: currentUser.displayName || currentUser.email || currentUser.phoneNumber || 'åŒ¿åç©å®¶', // Use display name, fallback to email/phone
                        userCountry: userCountry, // Save user's country
                        score: finalScore,
                        timeInSeconds: finalTime,
                        reached2048: reached2048, // New field to indicate if 2048 was reached
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log("Leaderboard entry saved!");
                } catch (error) {
                    console.error("Error saving leaderboard entry:", error);
                }
            } else {
                console.log("User not logged in, skipping leaderboard entry save.");
            }
        }


        /**
         * é¡¯ç¤ºéŠæˆ²çµæŸè¨Šæ¯ (æ ¹æ“šå˜´ç ²é–‹é—œ)ã€‚
         */
        function displayGameOverMessage() {
            let message;
            if (isRoastModeEnabled) {
                message = getTranslation('game_over_roast');
            } else {
                message = getTranslation('game_over_normal');
            }
            // éŠæˆ²çµæŸæˆ–å‹åˆ©çš„å½ˆçª—æ‡‰è©²æŒçºŒé¡¯ç¤ºï¼Œç›´åˆ°ç©å®¶é»æ“Šé‡æ–°é–‹å§‹
            showMessage(message, true);
        }

        /**
         * é¡¯ç¤ºéŠæˆ²å‹åˆ©è¨Šæ¯ (æ ¹æ“šå˜´ç ²é–‹é—œ)ã€‚
         */
        function displayWinMessage() {
            let message;
            const formattedTime = formatTime(totalSeconds);
            if (isRoastModeEnabled) {
                message = getTranslation('game_win_roast', { time: formattedTime, score: score });
            } else {
                message = getTranslation('game_win_normal', { time: formattedTime, score: score });
            }
            // éŠæˆ²çµæŸæˆ–å‹åˆ©çš„å½ˆçª—æ‡‰è©²æŒçºŒé¡¯ç¤ºï¼Œç›´åˆ°ç©å®¶é»æ“Šé‡æ–°é–‹å§‹
            showMessage(message, true);
        }

        /**
         * æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸ (æ²’æœ‰å¯ç§»å‹•çš„æ–¹å¡Šæˆ–å¯åˆä½µçš„æ–¹å¡Š)ã€‚
         * @returns {boolean} - å¦‚æœéŠæˆ²çµæŸè¿”å› trueï¼Œå¦å‰‡è¿”å› falseã€‚
         */
        function isGameOver() {
            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    if (board[row][col] === 0) return false;
                    if (col < boardSize - 1 && board[row][col] === board[row][col + 1]) return false;
                    if (row < boardSize - 1 && board[row][col] === board[row + 1][col]) return false;
                }
            }
            return true;
        }

        /**
         * é‡æ–°é–‹å§‹éŠæˆ² (ç„¡è«–åœ¨ä½•æ™‚é»æ“Š)ã€‚
         */
        function restartGame() {
            hideMessage(); // éš±è—ä»»ä½•å½ˆå‡ºçš„è¨Šæ¯æ¡† (é€™åŒ…æ‹¬å‹åˆ©/å¤±æ•—å½ˆçª—)
            // å¦‚æœéŠæˆ²è™•æ–¼æš«åœç‹€æ…‹ï¼Œå–æ¶ˆæš«åœ
            if (isPaused) {
                togglePause(); // é€™æœƒå°‡ isPaused è¨­ç‚º false, gameActive è¨­ç‚º true ä¸¦æ¢å¾©è¨ˆæ™‚
            }

            initGame(); // é‡æ–°åˆå§‹åŒ–éŠæˆ²
            resetTimer(); // é‡ç½®è¨ˆæ™‚å™¨
            startTimer();

            // ç¢ºä¿éŠæˆ²æ¿é‡æ–°å¯æ“ä½œï¼Œä¸¦ä¸”æš«åœæŒ‰éˆ•ç‹€æ…‹æ­£ç¢º
            gameActive = true;
            isPaused = false;
            pauseButton.textContent = getTranslation('pause');
            pauseButton.classList.remove('paused');
        }

        /**
         * å›åˆ°ä¸»é é¢ (é›£åº¦é¸æ“‡ç•«é¢)ã€‚
         */
        function goHome() {
            isTutorial = false;
            gameActive = false;
            isPaused = false;
            stopTimer();
            pauseButton.textContent = getTranslation('pause');
            pauseButton.classList.remove('paused');

            hideAllGameElements();
            hideMessage();
            difficultySelection.style.display = 'flex';
            roastModeToggleContainer.style.display = 'flex';
            authHeaderButton.style.display = 'flex'; // å›åˆ°ä¸»é æ™‚é¡¯ç¤ºå³ä¸Šè§’èªè­‰æŒ‰éˆ•
            userDropdown.style.display = 'none'; // ç¢ºä¿ä¸‹æ‹‰èœå–®éš±è—
            leaderboardButton.style.display = 'block'; // å›åˆ°ä¸»é æ™‚é¡¯ç¤ºæ’è¡Œæ¦œæŒ‰éˆ•
            mainSettingsButton.style.display = 'block'; // å›åˆ°ä¸»é æ™‚é¡¯ç¤ºè¨­å®šæŒ‰éˆ•
            userUidDisplay.style.display = 'block'; // å›åˆ°ä¸»é æ™‚é¡¯ç¤º UID é¡¯ç¤º
            updateAuthHeaderButton(); // ç¢ºä¿èªè­‰æŒ‰éˆ•æ–‡å­—æ­£ç¢º
            updatePageLanguage(currentLanguage); // Update language on home page
        }

        /**
         * éš±è—æ‰€æœ‰éŠæˆ²ç›¸é—œçš„é¡¯ç¤ºå…ƒç´ ï¼Œç”¨æ–¼åˆ‡æ›æ¨¡å¼æ™‚çš„æ¸…ç†ã€‚
         */
        function hideAllGameElements() {
            hideMessage(); // éš±è—éŠæˆ²çµæŸ/å‹åˆ©è¨Šæ¯ (ç¢ºä¿éš±è—å¸¶æœ‰å‹•ç•«)
            gameInfoArea.style.display = 'none'; // æ›´æ–° ID
            gameBoard.style.display = 'none';
            homeButton.style.display = 'none';
            pauseButton.style.display = 'none';
            restartButtonAlways.style.display = 'none'; // ç¢ºä¿é€™å€‹æŒ‰éˆ•ä¹Ÿéš±è—
            leaderboardModal.style.display = 'none'; // Ensure leaderboard modal is hidden
            accountSettingsModal.style.display = 'none'; // Ensure account settings modal is hidden
            mainSettingsModal.style.display = 'none'; // Ensure main settings modal is hidden
        }

        /* äº‹ä»¶ç›£è½å™¨ */

        // éµç›¤æ§åˆ¶ (ç®­é ­éµ)
        document.addEventListener('keydown', e => {
            if (!gameActive || isPaused) return;

            if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                e.preventDefault();
                switch (e.key) {
                    case 'ArrowLeft':
                        move('left');
                        break;
                    case 'ArrowRight':
                        move('right');
                        break;
                    case 'ArrowUp':
                        move('up');
                        break;
                    case 'ArrowDown':
                        move('down');
                        break;
                }
            }
        });

        // --- æ‰‹æ©Ÿè§¸æ§æ»‘å‹•æ§åˆ¶å„ªåŒ– (å°ˆæ³¨æ–¼éŠæˆ²æ¿å…§çš„æ»‘å‹•ï¼Œé¿å…å½±éŸ¿å¤–éƒ¨æŒ‰éˆ•) ---
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoved = false;

        gameBoard.addEventListener('touchstart', function(e) {
            if (!gameActive || isPaused) return;

            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchMoved = false;
        }, { passive: true });

        gameBoard.addEventListener('touchmove', function(e) {
            if (!gameActive || isPaused) return;

            const dx = e.touches[0].clientX - touchStartX;
            const dy = e.touches[0].clientY - touchStartY;
            const minMoveThreshold = 10;
            if (Math.abs(dx) > minMoveThreshold || Math.abs(dy) > minMoveThreshold) {
                touchMoved = true;
            }
            e.preventDefault();
        }, { passive: false });

        gameBoard.addEventListener('touchend', function(e) {
            if (!gameActive || isPaused) return;

            if (!touchMoved) {
                return;
            }

            const dx = e.changedTouches[0].clientX - touchStartX;
            const dy = e.changedTouches[0].clientY - touchStartY;

            const minSwipeDistance = 30;
            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > minSwipeDistance) {
                if (dx > 0) move('right');
                else move('left');
            } else if (Math.abs(dy) > minSwipeDistance) {
                if (dy > 0) move('down');
                else move('up');
            }
        }, { passive: true });
        // --- è§¸æ§äº‹ä»¶å„ªåŒ–çµæŸ ---

        /**
         * æª¢æŸ¥éŠæˆ²æ˜¯å¦å‹åˆ© (é”åˆ° 2048 æ–¹å¡Š)ã€‚
         * @returns {boolean} - å¦‚æœå‹åˆ©è¿”å› trueï¼Œå¦å‰‡è¿”å› falseã€‚
         */
        function checkWin() {
            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    if (board[row][col] === 2048) {
                        return true;
                    }
                }
            }
            return false;
        }

        // --- å˜´ç ²é–‹é—œé‚è¼¯ ---
        roastModeCheckbox.addEventListener('change', () => {
            isRoastModeEnabled = roastModeCheckbox.checked;
            localStorage.setItem('roastMode', isRoastModeEnabled ? 'enabled' : 'disabled');
        });

        // --- Firebase Authentication æ¨¡æ…‹æ¡†é‚è¼¯ ---

        // é¡¯ç¤ºæ¨¡æ…‹æ¡†
        authHeaderButton.addEventListener('click', () => {
            if (currentUser) {
                // å¦‚æœå·²ç™»å…¥ï¼Œé¡¯ç¤ºä¸‹æ‹‰èœå–®
                userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
            } else {
                // æœªç™»å…¥ï¼Œé¡¯ç¤ºèªè­‰æ¨¡æ…‹æ¡†çš„ä¸»é¸é …
                authModal.style.display = 'flex';
                authMainOptions.style.display = 'block';
                loginFormModal.style.display = 'none';
                registerFormModal.style.display = 'none';
                phoneAuthModal.style.display = 'none'; // Ensure phone auth is hidden
                accountSettingsModal.style.display = 'none'; // Ensure settings is hidden
            }
        });

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.addEventListener('click', (event) => {
            if (event.target === authModal || event.target === leaderboardModal || event.target === accountSettingsModal || event.target === mainSettingsModal) {
                authModal.style.display = 'none';
                leaderboardModal.style.display = 'none';
                accountSettingsModal.style.display = 'none';
                mainSettingsModal.style.display = 'none';
            }
            // é»æ“Šé é¢å…¶ä»–åœ°æ–¹æ™‚ï¼Œå¦‚æœä¸‹æ‹‰èœå–®æ‰“é–‹ï¼Œå‰‡é—œé–‰
            if (!authHeaderButton.contains(event.target) && !userDropdown.contains(event.target)) {
                userDropdown.style.display = 'none';
            }
        });

        // é—œé–‰æ¨¡æ…‹æ¡†æŒ‰éˆ•
        document.querySelectorAll('.modal .close-button').forEach(button => {
            button.addEventListener('click', (event) => {
                event.target.closest('.modal').style.display = 'none';
            });
        });

        // é¡¯ç¤ºç™»å…¥è¡¨å–®
        showLoginFormBtn.addEventListener('click', () => {
            authMainOptions.style.display = 'none';
            loginFormModal.style.display = 'block';
        });

        // é¡¯ç¤ºè¨»å†Šè¡¨å–®
        showRegisterFormBtn.addEventListener('click', () => {
            authMainOptions.style.display = 'none';
            registerFormModal.style.display = 'block';
        });

        // é¡¯ç¤ºé›»è©±èªè­‰è¡¨å–®
        phoneAuthButton.addEventListener('click', () => {
            authMainOptions.style.display = 'none';
            phoneAuthModal.style.display = 'block';
            setupRecaptcha(); // Setup reCAPTCHA when phone auth modal is shown
            // Reset phone auth form state
            phoneNumberInput.value = '';
            otpInput.value = '';
            otpInput.style.display = 'none';
            verifyOtpButton.style.display = 'none';
            phoneDisplayNameInput.value = '';
            phoneDisplayNameInput.style.display = 'none';
            setPhoneDisplayNameButton.style.display = 'none';
            sendOtpButton.style.display = 'block';
        });

        // è¿”å›ä¸»é¸å–®æŒ‰éˆ•
        backToMainAuthButtons.forEach(button => {
            button.addEventListener('click', () => {
                authModal.style.display = 'none'; // Hide auth modal completely
                leaderboardModal.style.display = 'none'; // Hide leaderboard
                accountSettingsModal.style.display = 'none'; // Hide account settings
                mainSettingsModal.style.display = 'none'; // Hide main settings

                // Show the appropriate main section based on current page state
                if (gameActive) {
                    // If a game is active, do nothing, just close the modal
                } else if (isTutorial) {
                    // If in tutorial mode, nothing specific to show
                } else {
                    difficultySelection.style.display = 'flex';
                    roastModeToggleContainer.style.display = 'flex';
                }

                // Reset specific forms that were shown
                loginFormModal.style.display = 'none';
                registerFormModal.style.display = 'none';
                phoneAuthModal.style.display = 'none';
                authMainOptions.style.display = 'block'; // Ensure auth main options are visible next time auth modal is opened

                if (firebaseRecaptchaVerifier) {
                    firebaseRecaptchaVerifier.clear(); // Clear reCAPTCHA when leaving phone auth
                }
            });
        });

        // ç™»å…¥åŠŸèƒ½
        loginBtnModal.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                alert(getTranslation('login_success'));
                authModal.style.display = 'none'; // ç™»å…¥æˆåŠŸå¾Œé—œé–‰æ¨¡æ…‹æ¡†
            } catch (error) {
                alert(getTranslation('login_failed') + error.message);
                console.error("ç™»å…¥å¤±æ•—:", error);
            }
        });

        // è¨»å†ŠåŠŸèƒ½ (åŒ…å«ä¿¡ç®±é©—è­‰å’Œæš±ç¨±è¨­å®š)
        registerBtnModal.addEventListener('click', async () => {
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            const confirmPassword = registerConfirmPasswordInput.value;

            if (password !== confirmPassword) {
                alert(getTranslation('password_mismatch'));
                return;
            }
            if (password.length < 6) {
                alert(getTranslation('password_too_short'));
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Prompt for nickname
                let displayName = prompt(getTranslation('register_success_prompt_nickname'));
                if (displayName) {
                    await user.updateProfile({ displayName: displayName });
                }
                // Set default country for new users
                await db.collection('users').doc(user.uid).set({
                    country: "Taiwan",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });


                await user.sendEmailVerification();
                alert(getTranslation('register_success_verify_email'));
                authModal.style.display = 'none'; // è¨»å†ŠæˆåŠŸå¾Œé—œé–‰æ¨¡æ…‹æ¡†
            } catch (error) {
                alert(getTranslation('register_failed') + error.message);
                console.error("è¨»å†Šå¤±æ•—:", error);
            }
        });

        // Google ç™»å…¥åŠŸèƒ½ (æ¨¡æ…‹æ¡†å…§)
        googleSigninBtnModal.addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
                // For Google login, if it's a new user, also set default country
                if (currentUser && currentUser.metadata.creationTime === currentUser.metadata.lastSignInTime) {
                    await db.collection('users').doc(currentUser.uid).set({
                        country: "Taiwan",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                }
                alert(getTranslation('google_login_success'));
                authModal.style.display = 'none'; // ç™»å…¥æˆåŠŸå¾Œé—œé–‰æ¨¡æ…‹æ¡†
            } catch (error) {
                alert(getTranslation('google_login_failed') + error.message);
                console.error("Google ç™»å…¥å¤±æ•—:", error);
            }
        });

        // é›»è©±èªè­‰ç›¸é—œåŠŸèƒ½
        function setupRecaptcha() {
            if (!firebaseRecaptchaVerifier) { // Only create if it doesn't exist
                firebaseRecaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible', // Use invisible reCAPTCHA
                    'callback': (response) => {
                        // reCAPTCHA solved, allow signInWithPhoneNumber.
                        // You can optionally call sendOtpButton.click() here automatically
                    },
                    'expired-callback': () => {
                        alert(getTranslation('recaptcha_expired'));
                        // Optionally refresh reCAPTCHA
                        firebaseRecaptchaVerifier.render().then(function(widgetId) {
                            grecaptcha.reset(widgetId);
                        });
                    }
                });
                firebaseRecaptchaVerifier.render().then(function(widgetId) {
                    // reCAPTCHA is rendered.
                });
            }
        }

        sendOtpButton.addEventListener('click', async () => {
            const phoneNumber = phoneNumberInput.value;
            if (!phoneNumber) {
                alert(getTranslation('enter_phone_number'));
                return;
            }
            if (!phoneNumber.startsWith('+')) {
                alert(getTranslation('phone_number_format_error'));
                return;
            }

            try {
                // Ensure reCAPTCHA is rendered and verified
                await firebaseRecaptchaVerifier.verify();
                confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, firebaseRecaptchaVerifier);
                alert(getTranslation('otp_sent'));
                sendOtpButton.style.display = 'none';
                phoneNumberInput.style.display = 'none'; // Hide phone number input
                otpInput.style.display = 'block';
                verifyOtpButton.style.display = 'block';
            } catch (error) {
                alert(getTranslation('otp_send_failed') + error.message);
                console.error("ç™¼é€é©—è­‰ç¢¼å¤±æ•—:", error);
                // Clear reCAPTCHA in case of error to allow retry
                if (firebaseRecaptchaVerifier) {
                    firebaseRecaptchaVerifier.render().then(function(widgetId) {
                        grecaptcha.reset(widgetId);
                    });
                }
            }
        });

        verifyOtpButton.addEventListener('click', async () => {
            const code = otpInput.value;
            if (!code) {
                alert(getTranslation('enter_otp'));
                return;
            }
            try {
                const userCredential = await confirmationResult.confirm(code);
                const user = userCredential.user;

                // Check if user is new or existing
                if (user.metadata.creationTime === user.metadata.lastSignInTime) {
                    // New user, prompt for display name and set default country
                    alert(getTranslation('phone_auth_success_prompt_nickname'));
                    otpInput.style.display = 'none';
                    verifyOtpButton.style.display = 'none';
                    phoneDisplayNameInput.style.display = 'block';
                    setPhoneDisplayNameButton.style.display = 'block';
                    phoneDisplayNameInput.focus();
                    await db.collection('users').doc(user.uid).set({
                        country: "Taiwan", // Set default country for new phone auth users
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } else {
                    // Existing user
                    alert(getTranslation('phone_login_success'));
                    authModal.style.display = 'none';
                }
            } catch (error) {
                alert(getTranslation('otp_verify_failed') + error.message);
                console.error("é©—è­‰å¤±æ•—:", error);
            }
        });

        setPhoneDisplayNameButton.addEventListener('click', async () => {
            const displayName = phoneDisplayNameInput.value;
            if (!displayName) {
                alert(getTranslation('nickname_cannot_be_empty'));
                return;
            }
            try {
                await auth.currentUser.updateProfile({ displayName: displayName });
                alert(getTranslation('nickname_set_success'));
                authModal.style.display = 'none';
            } catch (error) {
                alert(getTranslation('nickname_set_failed') + error.message);
                console.error("è¨­å®šæš±ç¨±å¤±æ•—:", error);
            }
        });

        // å¸³æˆ¶è¨­å®šåŠŸèƒ½
        accountSettingsBtnDropdown.addEventListener('click', async () => {
            if (currentUser) {
                userDropdown.style.display = 'none'; // Hide user dropdown
                authModal.style.display = 'flex'; // Show main auth modal as a container
                authMainOptions.style.display = 'none'; // Hide main auth options
                loginFormModal.style.display = 'none';
                registerFormModal.style.display = 'none';
                phoneAuthModal.style.display = 'none';

                accountSettingsModal.style.display = 'block'; // Show account settings modal

                // Load current settings
                settingsDisplayNameInput.value = currentUser.displayName || '';
                try {
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    if (userDoc.exists && userDoc.data().country) {
                        settingsCountrySelect.value = userDoc.data().country;
                    } else {
                        settingsCountrySelect.value = 'Taiwan'; // Default if not set
                    }
                } catch (error) {
                    console.error("Error loading user country:", error);
                    settingsCountrySelect.value = 'Taiwan'; // Fallback
                }
            } else {
                alert(getTranslation('please_login_first_settings'));
            }
        });

        saveAccountSettingsButton.addEventListener('click', async () => {
            if (!currentUser) return;

            const newDisplayName = settingsDisplayNameInput.value;
            const newCountry = settingsCountrySelect.value;
            let changesMade = false;

            try {
                // Update display name
                if (newDisplayName !== currentUser.displayName) {
                    await currentUser.updateProfile({ displayName: newDisplayName });
                    changesMade = true;
                }

                // Update country in Firestore
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const currentCountry = userDoc.exists ? userDoc.data().country : null;

                if (newCountry !== currentCountry) {
                    await db.collection('users').doc(currentUser.uid).set({
                        country: newCountry,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    changesMade = true;
                }

                if (changesMade) {
                    alert(getTranslation('settings_saved_success'));
                } else {
                    alert(getTranslation('no_settings_changed'));
                }
                accountSettingsModal.style.display = 'none';
                authModal.style.display = 'none'; // Close the auth container modal
            } catch (error) {
                alert(getTranslation('settings_save_failed') + error.message);
                console.error("å„²å­˜å¸³æˆ¶è¨­å®šå¤±æ•—:", error);
            }
        });


        // ç™»å‡ºåŠŸèƒ½ (ä¸‹æ‹‰èœå–®å…§)
        logoutBtnDropdown.addEventListener('click', async () => {
            try {
                await auth.signOut();
                alert(getTranslation('logout_success'));
                userDropdown.style.display = 'none'; // é—œé–‰ä¸‹æ‹‰èœå–®
                goHome(); // ç™»å‡ºå¾Œå›åˆ°ä¸»é 
                if (firebaseRecaptchaVerifier) {
                    firebaseRecaptchaVerifier.clear(); // Clear reCAPTCHA on logout
                }
            } catch (error) {
                alert(getTranslation('logout_failed') + error.message);
                console.error("ç™»å‡ºå¤±æ•—:", error);
            }
        });

        // ä¸»é è¨­å®šæŒ‰éˆ•é‚è¼¯
        mainSettingsButton.addEventListener('click', () => {
            mainSettingsModal.style.display = 'flex';
            // Set current language in select box
            languageSelect.value = currentLanguage;
        });

        languageSelect.addEventListener('change', (event) => {
            const newLanguage = event.target.value;
            localStorage.setItem('gameLanguage', newLanguage);
            currentLanguage = newLanguage;
            updatePageLanguage(newLanguage);
            alert(getTranslation('language_changed_alert'));
        });

        // èªè¨€åŒ…
        const translations = {
            'zh-Hant': {
                'title': '2048 éŠæˆ²',
                'login_register': 'ç™»å…¥ / è¨»å†Š',
                'welcome_user': 'æ­¡è¿ï¼Œ{user}ï¼',
                'account_settings': 'å¸³æˆ¶è¨­å®š',
                'logout': 'ç™»å‡º',
                'score': 'åˆ†æ•¸',
                'high_score': 'æœ€é«˜åˆ†',
                'time': 'æ™‚é–“',
                'restart': 'é‡æ–°é–‹å§‹',
                'game_over_normal': 'éŠæˆ²çµæŸ',
                'game_over_roast': 'ä½ æ€éº¼é‚£éº¼èœï¼Œé€£2048éƒ½ç©ä¸åˆ°',
                'game_win_normal': 'æ­å–œåˆ°é”2048ä¸¦ä¸”èŠ±äº†{time}å¾—äº†{score}åˆ†',
                'game_win_roast': 'ä¹Ÿæ²’å¤šå²å®³ï¼Œé‚„ä¸æ˜¯èŠ±äº†{time}æ‰{score}åˆ†è€Œå·²',
                'board_size_selection': 'é¸æ“‡æ¿é¢å°ºå¯¸',
                'standard_4x4': '4 x 4 (æ¨™æº–)',
                'tutorial_mode': 'æ•™å­¸æ¨¡å¼',
                'leaderboard': 'æ’è¡Œæ¦œ',
                'home': 'å›åˆ°ä¸»é ',
                'pause': 'æš«åœ',
                'continue': 'ç¹¼çºŒ',
                'game_paused': 'éŠæˆ²å·²æš«åœ',
                'roast_mode': 'å˜´ç ²æ¨¡å¼',
                'feedback': 'æ„è¦‹åé¥‹',
                'feedback_web_gmail': 'ç”¨ç¶²é ç‰ˆ Gmail',
                'feedback_app_email': 'ç”¨éƒµä»¶æ‡‰ç”¨ç¨‹å¼',
                'account_operations': 'å¸³æˆ¶æ“ä½œ',
                'login': 'ç™»å…¥',
                'register': 'è¨»å†Š',
                'phone_login_register': 'é›»è©±ç™»å…¥ / è¨»å†Š',
                'login_with_google': 'ä½¿ç”¨ Google ç™»å…¥',
                'email': 'é›»å­éƒµä»¶',
                'password': 'å¯†ç¢¼',
                'confirm_password': 'å†æ¬¡ç¢ºèªå¯†ç¢¼',
                'phone_number': 'è¼¸å…¥é›»è©±è™Ÿç¢¼ (+åœ‹ç¢¼)',
                'send_otp': 'ç™¼é€é©—è­‰ç¢¼',
                'enter_otp': 'è¼¸å…¥é©—è­‰ç¢¼',
                'verify': 'é©—è­‰',
                'enter_nickname': 'è¼¸å…¥ä½ çš„æš±ç¨±',
                'set_nickname': 'è¨­å®šæš±ç¨±',
                'back': 'è¿”å›',
                'ranking': 'æ’å',
                'user': 'ä½¿ç”¨è€…',
                'country': 'åœ‹å®¶',
                'sort_by_score': 'ä¾åˆ†æ•¸æ’å',
                'sort_by_time': 'ä¾æ™‚é–“æ’å',
                'no_leaderboard_data': 'ç›®å‰æ²’æœ‰æ’è¡Œæ¦œè³‡æ–™ã€‚',
                'your_uid': 'æ‚¨çš„ UID: {uid}',
                'nickname': 'æš±ç¨±',
                'new_nickname': 'è¼¸å…¥æ–°æš±ç¨±',
                'save_settings': 'å„²å­˜è¨­å®š',
                'settings': 'è¨­å®š',
                'language': 'èªè¨€',
                'traditional_chinese': 'ç¹é«”ä¸­æ–‡',
                'english': 'English',
                'login_success': 'ç™»å…¥æˆåŠŸï¼',
                'login_failed': 'ç™»å…¥å¤±æ•—: ',
                'password_mismatch': 'å¯†ç¢¼å’Œç¢ºèªå¯†ç¢¼ä¸ç¬¦ï¼',
                'password_too_short': 'å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—å…ƒï¼',
                'register_success_prompt_nickname': 'è¨»å†ŠæˆåŠŸï¼è«‹è¼¸å…¥æ‚¨çš„æš±ç¨± (é¸å¡«):',
                'register_success_verify_email': 'è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥æ‚¨çš„é›»å­éƒµä»¶ä»¥é€²è¡Œé©—è­‰ã€‚',
                'register_failed': 'è¨»å†Šå¤±æ•—: ',
                'google_login_success': 'Google ç™»å…¥æˆåŠŸï¼',
                'google_login_failed': 'Google ç™»å…¥å¤±æ•—: ',
                'recaptcha_expired': 'reCAPTCHA å·²éæœŸï¼Œè«‹é‡è©¦ã€‚',
                'enter_phone_number': 'è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼ï¼',
                'phone_number_format_error': 'é›»è©±è™Ÿç¢¼å¿…é ˆåŒ…å«åœ‹éš›å€ç¢¼ï¼Œä¾‹å¦‚ +886912345678',
                'otp_sent': 'é©—è­‰ç¢¼å·²ç™¼é€ï¼',
                'otp_send_failed': 'ç™¼é€é©—è­‰ç¢¼å¤±æ•—: ',
                'otp_verify_failed': 'é©—è­‰å¤±æ•—: ',
                'phone_auth_success_prompt_nickname': 'é›»è©±è™Ÿç¢¼é©—è­‰æˆåŠŸï¼è«‹è¨­å®šæ‚¨çš„æš±ç¨±ã€‚',
                'phone_login_success': 'é›»è©±ç™»å…¥æˆåŠŸï¼',
                'nickname_cannot_be_empty': 'æš±ç¨±ä¸èƒ½ç‚ºç©ºï¼',
                'nickname_set_success': 'æš±ç¨±è¨­å®šæˆåŠŸï¼',
                'nickname_set_failed': 'è¨­å®šæš±ç¨±å¤±æ•—: ',
                'please_login_first_settings': 'è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œå¸³æˆ¶è¨­å®šï¼',
                'settings_saved_success': 'å¸³æˆ¶è¨­å®šå·²å„²å­˜ï¼',
                'no_settings_changed': 'æ²’æœ‰è¨­å®šè¢«æ›´æ”¹ã€‚',
                'settings_save_failed': 'å„²å­˜å¸³æˆ¶è¨­å®šå¤±æ•—: ',
                'logout_success': 'ç™»å‡ºæˆåŠŸï¼',
                'logout_failed': 'ç™»å‡ºå¤±æ•—: ',
                'tutorial_complete_message': 'æ•™å­¸å®Œæˆï¼ç¾åœ¨ä½ å¯ä»¥é¸æ“‡é›£åº¦é–‹å§‹è‡ªå·±çš„éŠæˆ²å›‰ï¼',
                'tutorial_wrong_move_alert': 'éŒ¯äº†å–”ï¼é€™æ­¥è¦å¾€ã€Œ{direction}ã€æ‰å°ï¼Œç…§æç¤ºåšå•¦ï¼',
                'left': 'å·¦', 'right': 'å³', 'up': 'ä¸Š', 'down': 'ä¸‹',
                'language_changed_alert': 'èªè¨€å·²æ›´æ”¹ï¼'
            },
            'en': {
                'title': '2048 Game',
                'login_register': 'Login / Register',
                'welcome_user': 'Welcome, {user}!',
                'account_settings': 'Account Settings',
                'logout': 'Logout',
                'score': 'Score',
                'high_score': 'High Score',
                'time': 'Time',
                'restart': 'Restart',
                'game_over_normal': 'Game Over',
                'game_over_roast': 'You are so bad, can\'t even reach 2048',
                'game_win_normal': 'Congratulations! You reached 2048 in {time} with {score} points.',
                'game_win_roast': 'Not that impressive, only {score} points in {time}.',
                'board_size_selection': 'Select Board Size',
                'standard_4x4': '4 x 4 (Standard)',
                'tutorial_mode': 'Tutorial Mode',
                'leaderboard': 'Leaderboard',
                'home': 'Home',
                'pause': 'Pause',
                'continue': 'Continue',
                'game_paused': 'Game Paused',
                'roast_mode': 'Roast Mode',
                'feedback': 'Feedback',
                'feedback_web_gmail': 'Use Web Gmail',
                'feedback_app_email': 'Use Email App',
                'account_operations': 'Account Operations',
                'login': 'Login',
                'register': 'Register',
                'phone_login_register': 'Phone Login / Register',
                'login_with_google': 'Login with Google',
                'email': 'Email',
                'password': 'Password',
                'confirm_password': 'Confirm Password',
                'phone_number': 'Enter Phone Number (+Country Code)',
                'send_otp': 'Send OTP',
                'enter_otp': 'Enter OTP',
                'verify': 'Verify',
                'enter_nickname': 'Enter your nickname',
                'set_nickname': 'Set Nickname',
                'back': 'Back',
                'ranking': 'Rank',
                'user': 'User',
                'country': 'Country',
                'sort_by_score': 'Sort by Score',
                'sort_by_time': 'Sort by Time',
                'no_leaderboard_data': 'No leaderboard data available.',
                'your_uid': 'Your UID: {uid}',
                'nickname': 'Nickname',
                'new_nickname': 'Enter new nickname',
                'save_settings': 'Save Settings',
                'settings': 'Settings',
                'language': 'Language',
                'traditional_chinese': 'Traditional Chinese',
                'english': 'English',
                'login_success': 'Login successful!',
                'login_failed': 'Login failed: ',
                'password_mismatch': 'Password and confirm password do not match!',
                'password_too_short': 'Password must be at least 6 characters long!',
                'register_success_prompt_nickname': 'Registration successful! Please enter your nickname (optional):',
                'register_success_verify_email': 'Registration successful! Please check your email for verification.',
                'register_failed': 'Registration failed: ',
                'google_login_success': 'Google login successful!',
                'google_login_failed': 'Google login failed: ',
                'recaptcha_expired': 'reCAPTCHA expired, please try again.',
                'enter_phone_number': 'Please enter phone number!',
                'phone_number_format_error': 'Phone number must include country code, e.g., +1234567890',
                'otp_sent': 'OTP sent!',
                'otp_send_failed': 'Failed to send OTP: ',
                'otp_verify_failed': 'Verification failed: ',
                'phone_auth_success_prompt_nickname': 'Phone number verification successful! Please set your nickname.',
                'phone_login_success': 'Phone login successful!',
                'nickname_cannot_be_empty': 'Nickname cannot be empty!',
                'nickname_set_success': 'Nickname set successfully!',
                'nickname_set_failed': 'Failed to set nickname: ',
                'please_login_first_settings': 'Please log in first to access account settings!',
                'settings_saved_success': 'Account settings saved successfully!',
                'no_settings_changed': 'No settings were changed.',
                'settings_save_failed': 'Failed to save account settings: ',
                'logout_success': 'Logout successful!',
                'logout_failed': 'Logout failed: ',
                'tutorial_complete_message': 'Tutorial complete! You can now choose a difficulty and start your own game!',
                'tutorial_wrong_move_alert': 'Wrong move! You need to move "{direction}" as per the hint!',
                'left': 'left', 'right': 'right', 'up': 'up', 'down': 'down',
                'language_changed_alert': 'Language changed!'
            }
        };

        function getTranslation(key, params = {}) {
            let text = translations[currentLanguage][key] || translations['zh-Hant'][key] || key; // Fallback to Traditional Chinese then key itself
            for (const param in params) {
                text = text.replace(`{${param}}`, params[param]);
            }
            return text;
        }

        function updatePageLanguage(lang) {
            document.title = getTranslation('title');
            document.querySelector('h1').textContent = getTranslation('title');
            document.getElementById('auth-display-name').textContent = getTranslation('login_register');
            document.getElementById('score-board').firstChild.textContent = getTranslation('score') + ': ';
            document.getElementById('high-score-board').firstChild.textContent = getTranslation('high_score') + ': ';
            document.getElementById('timer-display-container').firstChild.textContent = getTranslation('time') + ': ';
            document.getElementById('restart-button-always').textContent = getTranslation('restart');
            document.querySelector('#difficulty-selection h2').textContent = getTranslation('board_size_selection');
            document.querySelector('#difficulty-selection button:nth-child(2)').textContent = getTranslation('standard_4x4');
            document.querySelector('#difficulty-selection button:nth-child(3)').textContent = '5 x 5';
            document.querySelector('#difficulty-selection button:nth-child(4)').textContent = '6 x 6';
            document.querySelector('#difficulty-selection button:nth-child(5)').textContent = '7 x 7';
            document.querySelector('#difficulty-selection button:nth-child(6)').textContent = getTranslation('tutorial_mode');
            document.getElementById('leaderboard-button').textContent = getTranslation('leaderboard');
            document.getElementById('home-button').textContent = getTranslation('home');
            document.getElementById('pause-button').textContent = getTranslation(isPaused ? 'continue' : 'pause');
            document.getElementById('roast-mode-toggle-container label').textContent = getTranslation('roast_mode');
            document.getElementById('main-feedback-button').textContent = getTranslation('feedback');
            document.getElementById('feedback-web').textContent = getTranslation('feedback_web_gmail');
            document.getElementById('feedback-app').textContent = getTranslation('feedback_app_email');

            // Auth Modal
            document.querySelector('#auth-main-options h2').textContent = getTranslation('account_operations');
            document.getElementById('show-login-form').textContent = getTranslation('login');
            document.getElementById('show-register-form').textContent = getTranslation('register');
            document.getElementById('phone-auth-button').textContent = getTranslation('phone_login_register');
            document.getElementById('google-signin-btn-modal').textContent = getTranslation('login_with_google');

            document.querySelector('#login-form-modal h2').textContent = getTranslation('login');
            loginEmailInput.placeholder = getTranslation('email');
            loginPasswordInput.placeholder = getTranslation('password');
            document.getElementById('login-btn-modal').textContent = getTranslation('login');

            document.querySelector('#register-form-modal h2').textContent = getTranslation('register');
            registerEmailInput.placeholder = getTranslation('email');
            registerPasswordInput.placeholder = getTranslation('password');
            registerConfirmPasswordInput.placeholder = getTranslation('confirm_password');
            document.getElementById('register-btn-modal').textContent = getTranslation('register');

            document.querySelector('#phone-auth-modal h2').textContent = getTranslation('phone_login_register');
            phoneNumberInput.placeholder = getTranslation('phone_number');
            sendOtpButton.textContent = getTranslation('send_otp');
            otpInput.placeholder = getTranslation('enter_otp');
            verifyOtpButton.textContent = getTranslation('verify');
            phoneDisplayNameInput.placeholder = getTranslation('enter_nickname');
            setPhoneDisplayNameButton.textContent = getTranslation('set_nickname');

            document.querySelectorAll('.back-to-main-auth').forEach(btn => btn.textContent = getTranslation('back'));

            // User dropdown
            document.getElementById('account-settings-btn-dropdown').textContent = getTranslation('account_settings');
            document.getElementById('logout-btn-dropdown').textContent = getTranslation('logout');

            // Leaderboard Modal
            document.querySelector('#leaderboard-modal h2').textContent = getTranslation('leaderboard');
            sortbyScoreButton.textContent = getTranslation('sort_by_score');
            sortByTimeButton.textContent = getTranslation('sort_by_time');
            document.querySelector('#leaderboard-modal th:nth-child(1)').textContent = getTranslation('ranking');
            document.querySelector('#leaderboard-modal th:nth-child(2)').textContent = getTranslation('user');
            document.querySelector('#leaderboard-modal th:nth-child(3)').textContent = getTranslation('country');
            document.querySelector('#leaderboard-modal th:nth-child(4)').textContent = getTranslation('score');
            document.querySelector('#leaderboard-modal th:nth-child(5)').textContent = getTranslation('time');

            // Account Settings Modal
            document.querySelector('#account-settings-modal h2').textContent = getTranslation('account_settings');
            document.querySelector('label[for="settings-display-name"]').textContent = getTranslation('nickname') + ':';
            settingsDisplayNameInput.placeholder = getTranslation('new_nickname');
            document.querySelector('label[for="settings-country"]').textContent = getTranslation('country') + ':';
            saveAccountSettingsButton.textContent = getTranslation('save_settings');

            // Main Settings Modal
            document.getElementById('main-settings-button').textContent = getTranslation('settings');
            document.querySelector('#main-settings-modal h2').textContent = getTranslation('settings');
            document.querySelector('label[for="language-select"]').textContent = getTranslation('language') + ':';
            document.querySelector('#language-select option[value="zh-Hant"]').textContent = getTranslation('traditional_chinese');
            document.querySelector('#language-select option[value="en"]').textContent = getTranslation('english');

            // Update user UID display
            if (currentUser) {
                userUidDisplay.textContent = getTranslation('your_uid', { uid: currentUser.uid });
            }
        }


        // æ›´æ–°å³ä¸Šè§’èªè­‰æŒ‰éˆ•çš„é¡¯ç¤º
        function updateAuthHeaderButton() {
            if (currentUser) {
                authDisplayName.textContent = currentUser.displayName || currentUser.email || currentUser.phoneNumber || getTranslation('login_register');
                userEmailDropdown.textContent = currentUser.displayName || currentUser.email || currentUser.phoneNumber || 'N/A';
                authHeaderButton.classList.add('user-logged-in');
                userUidDisplay.textContent = getTranslation('your_uid', { uid: currentUser.uid });
                userUidDisplay.style.display = 'block';
            } else {
                authDisplayName.textContent = getTranslation('login_register');
                authHeaderButton.classList.remove('user-logged-in');
                userDropdown.style.display = 'none'; // ç¢ºä¿ç™»å‡ºæ™‚ä¸‹æ‹‰èœå–®æ˜¯é—œé–‰çš„
                userUidDisplay.textContent = '';
                userUidDisplay.style.display = 'none';
            }
        }

        // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
        auth.onAuthStateChanged(user => {
            currentUser = user; // æ›´æ–°å…¨åŸŸçš„ currentUser
            updateAuthHeaderButton(); // æ›´æ–°å³ä¸Šè§’æŒ‰éˆ•ç‹€æ…‹

            // ä¸å†ç›´æ¥é¡¯ç¤º auth-containerï¼Œè€Œæ˜¯æ ¹æ“šcurrentUserç‹€æ…‹æ±ºå®šæ˜¯å¦è¼‰å…¥æœ€é«˜åˆ†
            if (user) {
                loadHighScore(); // ç”¨æˆ¶ç™»å…¥å¾Œé‡æ–°è¼‰å…¥å…¶Firestoreæœ€é«˜åˆ†
            } else {
                loadHighScore(); // ç”¨æˆ¶ç™»å‡ºå¾Œè¼‰å…¥localStorageæœ€é«˜åˆ†
            }
            // Ensure reCAPTCHA is set up if not logged in and on home page
            if (!user && difficultySelection.style.display === 'flex') {
                setupRecaptcha();
            }
        });

        // é é¢è¼‰å…¥æ™‚å…ˆåˆå§‹åŒ–å˜´ç ²é–‹é—œå’Œèªè­‰æŒ‰éˆ•é¡¯ç¤º
        document.addEventListener('DOMContentLoaded', () => {
            roastModeCheckbox.checked = isRoastModeEnabled;
            // Load language from localStorage or default
            currentLanguage = localStorage.getItem('gameLanguage') || 'zh-Hant';
            updatePageLanguage(currentLanguage);
            languageSelect.value = currentLanguage; // Set the select box to current language

            // onAuthStateChanged æœƒåœ¨ Firebase åˆå§‹åŒ–å¾Œè‡ªå‹•è§¸ç™¼ï¼Œæ‰€ä»¥é€™è£¡ä¸éœ€è¦å†æ¬¡å‘¼å« updateAuthHeaderButton() æˆ– loadHighScore()
            // Make sure the leaderboard and main settings button is visible on home page load
            leaderboardButton.style.display = 'block';
            mainSettingsButton.style.display = 'block';
        });

    </script>
</body>
</html>