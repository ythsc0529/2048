<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2048æ™‚é–“</title>
    <style>
        /* æ•´é«”é é¢æ¨£å¼è¨­å®š */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh; /* åœ¨å°è¢å¹•ä¸Šä¿æŒä½”æ»¿è¦–çª—é«˜åº¦ */
            margin: 0;
            background-color: #faf8ef;
        }

        /* é‡å°è¢å¹•å¯¬åº¦å°æ–¼æˆ–ç­‰æ–¼ 767px (é€šå¸¸ç‚ºæ‰‹æ©Ÿ/å¹³æ¿) æ‡‰ç”¨ç‰¹å®šæ¨£å¼ */
        @media (max-width: 767px) {
            body {
                overflow: hidden; /* é˜²æ­¢æ‰‹æ©Ÿæ»¾å‹•ï¼Œåªåœ¨æ‰‹æ©Ÿä¸Šç”Ÿæ•ˆ */
            }
        }

        /* é‡å°è¢å¹•å¯¬åº¦å¤§æ–¼æˆ–ç­‰æ–¼ 768px (é€šå¸¸ç‚ºå¹³æ¿/æ¡Œé¢) æ‡‰ç”¨ç‰¹å®šæ¨£å¼ */
        @media (min-width: 768px) {
            body {
                height: auto; /* åœ¨æ¡Œé¢ç‰ˆæ™‚ï¼Œé«˜åº¦è‡ªå‹•é©æ‡‰å…§å®¹ */
                min-height: 100vh; /* è‡³å°‘ä½”æ»¿ä¸€å€‹è¦–çª—é«˜åº¦ */
                overflow-y: auto; /* å…è¨±å‚ç›´æ»¾å‹•æ¢å‡ºç¾ï¼Œå¦‚æœå…§å®¹è¶…å‡º */
                overflow-x: hidden; /* æ°´å¹³æ–¹å‘ä¸å…è¨±æ»¾å‹•ï¼Œé¿å…ä¸å¿…è¦çš„æ©«å‘æ»¾å‹•æ¢ */
            }
        }
        /* åˆ†æ•¸æ¿å®¹å™¨æ¨£å¼ */
        #game-info {
            display: flex;
            justify-content: center; /* åˆ†æ•¸å±…ä¸­ */
            align-items: center;
            width: calc(var(--tile-size) * var(--board-size) + var(--grid-gap) * (var(--board-size) - 1) + 20px); /* èˆ‡éŠæˆ²æ¿å¯¬åº¦ä¸€è‡´ */
            max-width: 500px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            margin-bottom: 20px;
            padding: 0 10px; /* å·¦å³å…§é‚Šè· */
        }

        #score-board {
            font-size: 24px;
            font-weight: bold;
            color: #776e65;
            background-color: #eee4da;
            padding: 10px 15px;
            border-radius: 8px;
        }
        /* è¨ˆæ™‚å™¨é¡¯ç¤ºå€æ¨£å¼ (åœ¨éŠæˆ²æ¿ä¸‹æ–¹) */
        #timer-display-container {
            display: none; /* é è¨­éš±è— */
            width: calc(var(--tile-size) * var(--board-size) + var(--grid-gap) * (var(--board-size) - 1) + 20px); /* èˆ‡éŠæˆ²æ¿å¯¬åº¦ä¸€è‡´ */
            max-width: 500px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            margin-top: 20px; /* èˆ‡éŠæˆ²æ¿çš„é–“è· */
            text-align: center;
        }

        #timer-display {
            font-size: 24px;
            font-weight: bold;
            color: #776e65;
            background-color: #eee4da;
            padding: 10px 15px;
            border-radius: 8px;
            display: inline-block; /* è®“èƒŒæ™¯æ¡†åªåŒ…ä½å…§å®¹ */
        }


        /* éŠæˆ²æ¿æ¨£å¼ */
        #game-board {
            display: grid; /* ä½¿ç”¨ Grid ä½ˆå±€ */
            background-color: #bbada0; /* èƒŒæ™¯é¡è‰² */
            padding: 10px; /* å…§é‚Šè· */
            border-radius: 10px; /* åœ“è§’ */
            position: relative; /* ç›¸å°å®šä½ï¼Œç”¨æ–¼éŠæˆ²çµæŸç•«é¢çš„çµ•å°å®šä½ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            /* ä½¿ç”¨ CSS è®Šæ•¸å‹•æ…‹è¨­å®šç¶²æ ¼é–“è·å’Œæ–¹å¡Šå¤§å° */
            --grid-gap: 10px; /* é è¨­ç¶²æ ¼é–“è· */
            grid-gap: var(--grid-gap); /* ç¶²æ ¼é–“è· */
            /* æœ€å¤§å¯¬åº¦é™åˆ¶ï¼Œç¢ºä¿åœ¨PCä¸Šä¸æœƒå¤ªå¤§ */
            max-width: calc(var(--tile-size) * var(--board-size) + var(--grid-gap) * (var(--board-size) + 1));
        }
        /* æ–¹å¡Š(tile)çš„é€šç”¨æ¨£å¼ */
        .tile {
            /* é—œéµä¿®æ­£ï¼šæ–¹å¡Šå¤§å°ä½¿ç”¨å‹•æ…‹è¨ˆç®— */
            width: var(--tile-size);
            height: var(--tile-size);
            background-color: #cdc1b4; /* é è¨­èƒŒæ™¯é¡è‰² */
            display: flex; /* ä½¿ç”¨ Flexbox å±…ä¸­å…§å®¹ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            font-size: 36px; /* å­—é«”å¤§å° */
            font-weight: bold; /* å­—é«”ç²—ç´° */
            color: #776e65; /* å­—é«”é¡è‰² */
            border-radius: 5px; /* åœ“è§’ */
            transition: transform 0.2s, background-color 0.2s; /* éæ¸¡æ•ˆæœï¼Œç”¨æ–¼å‹•ç•« */
        }
        /* å­—é«”å¤§å°éŸ¿æ‡‰å¼èª¿æ•´ (é‡å°ä¸åŒå¤§å°çš„æ–¹å¡Š) */
        .tile[data-value="128"], .tile[data-value="256"], .tile[data-value="512"] { font-size: 30px; }
        .tile[data-value="1024"], .tile[data-value="2048"] { font-size: 24px; }
        /* ä¸åŒæ•¸å€¼çš„æ–¹å¡ŠèƒŒæ™¯é¡è‰²å’Œå­—é«”é¡è‰² */
        .tile[data-value="2"] { background-color: #eee4da; }
        .tile[data-value="4"] { background-color: #ede0c8; }
        .tile[data-value="8"] { background-color: #f2b179; color: #f9f6f2; }
        .tile[data-value="16"] { background-color: #f59563; color: #f9f9f2; }
        .tile[data-value="32"] { background-color: #f67c5f; color: #f9f6f2; }
        .tile[data-value="64"] { background-color: #f65e3b; color: #f9f6f2; }
        .tile[data-value="128"] { background-color: #edcf72; color: #f9f6f2; }
        .tile[data-value="256"] { background-color: #edcc61; color: #f9f6f2; }
        .tile[data-value="512"] { background-color: #edc850; color: #f9f6f2; }
        .tile[data-value="1024"] { background-color: #edc53f; color: #f9f6f2; }
        .tile[data-value="2048"] { background-color: #edc22e; color: #f9f6f2; }
        /* åˆä½µå‹•ç•«æ•ˆæœ */
        .tile.merge {
            animation: merge 0.3s ease-in-out; /* æ‡‰ç”¨ merge å‹•ç•« */
        }
        /* merge å‹•ç•«é—œéµå½±æ ¼ */
        @keyframes merge {
            0% {
                transform: scale(1.2); /* åˆå§‹æ”¾å¤§ */
            }
            50% {
                transform: scale(1.3); /* ä¸­é–“æ›´å¤§ */
            }
            100% {
                transform: scale(1); /* æ¢å¾©åŸå§‹å¤§å° */
            }
        }
        /* éŠæˆ²çµæŸ/å‹åˆ©ç•«é¢æ¨£å¼ */
        #game-over {
            display: none; /* é è¨­éš±è— */
            position: absolute; /* çµ•å°å®šä½ */
            top: 50%; /* å‚ç›´å±…ä¸­ */
            left: 50%; /* æ°´å¹³å±…ä¸­ */
            transform: translate(-50%, -50%); /* ç²¾ç¢ºå±…ä¸­ */
            background-color: rgba(0, 0, 0, 0.7); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            color: #fff; /* ç™½è‰²å­—é«” */
            padding: 20px; /* å…§é‚Šè· */
            border-radius: 10px; /* åœ“è§’ */
            text-align: center; /* æ–‡å­—å±…ä¸­ */
            z-index: 10; /* ç¢ºä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
        }
        /* éŠæˆ²çµæŸ/å‹åˆ©ç•«é¢æŒ‰éˆ•æ¨£å¼ */
        #game-over button {
            margin-top: 10px; /* ä¸Šæ–¹é–“è· */
            padding: 10px 20px; /* å…§é‚Šè· */
            font-size: 18px; /* å­—é«”å¤§å° */
            border: none; /* ç„¡é‚Šæ¡† */
            background-color: #f67c5f; /* èƒŒæ™¯é¡è‰² */
            color: #fff; /* å­—é«”é¡è‰² */
            border-radius: 5px; /* åœ“è§’ */
            cursor: pointer; /* æ»‘é¼ æŒ‡é‡è®Šç‚ºæ‰‹å‹ */
        }
        /* å›åˆ°ä¸»é æŒ‰éˆ•æ¨£å¼ */
        #home-button {
            display: none; /* é è¨­éš±è— */
            margin-top: 20px; /* å¢åŠ ä¸Šæ–¹é–“è· */
            padding: 10px 20px; /* å…§é‚Šè· */
            font-size: 18px; /* å­—é«”å¤§å° */
            border: none; /* ç„¡é‚Šæ¡† */
            background-color: #8f7a66; /* èƒŒæ™¯é¡è‰² */
            color: #fff; /* å­—é«”é¡è‰² */
            border-radius: 5px; /* åœ“è§’ */
            cursor: pointer; /* æ»‘é¼ æŒ‡é‡è®Šç‚ºæ‰‹å‹ */
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); /* é™°å½±æ•ˆæœ */
            transition: background-color 0.3s; /* éæ¸¡æ•ˆæœ */
        }
        #home-button:hover {
            background-color: #a08d7a; /* é¼ æ¨™æ‡¸åœæ™‚çš„èƒŒæ™¯é¡è‰² */
        }
        /* é›£åº¦é¸æ“‡å€å¡Šæ¨£å¼ */
        #difficulty-selection {
            display: flex; /* ä½¿ç”¨ Flexbox ä½ˆå±€ */
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            gap: 15px; /* æŒ‰éˆ•é–“è· */
            align-items: center; /* æ°´å¹³å±…ä¸­ */
        }
        #difficulty-selection button {
            padding: 12px 25px; /* å…§é‚Šè· */
            font-size: 20px; /* å­—é«”å¤§å° */
            border: none; /* ç„¡é‚Šæ¡† */
            background-color: #8f7a66; /* èƒŒæ™¯é¡è‰² */
            color: #fff; /* å­—é«”é¡è‰² */
            border-radius: 8px; /* åœ“è§’ */
            cursor: pointer; /* æ»‘é¼ æŒ‡é‡è®Šç‚ºæ‰‹å‹ */
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); /* é™°å½±æ•ˆæœ */
            transition: background-color 0.3s; /* éæ¸¡æ•ˆæœ */
            width: 180px; /* å›ºå®šæŒ‰éˆ•å¯¬åº¦ï¼Œè®“å®ƒå€‘å°é½Š */
        }
        #difficulty-selection button:hover {
            background-color: #a08d7a; /* é¼ æ¨™æ‡¸åœæ™‚çš„èƒŒæ™¯é¡è‰² */
        }

        /* æ–°å¢ï¼šæ„è¦‹åé¥‹ä¸»è¦æŒ‰éˆ•æ¨£å¼ */
        #main-feedback-button {
            position: fixed; /* å›ºå®šå®šä½ */
            bottom: 20px; /* è·é›¢åº•éƒ¨ 20px */
            right: 20px; /* è·é›¢å³å´ 20px */
            background-color: #8f7a66; /* èƒŒæ™¯é¡è‰² */
            color: #fff; /* å­—é«”é¡è‰² */
            padding: 10px 15px;
            border-radius: 8px; /* åœ“è§’ */
            font-weight: bold; /* å­—é«”ç²—ç´° */
            text-decoration: none; /* ç„¡ä¸‹åŠƒç·š */
            font-size: 16px; /* å­—é«”å¤§å° */
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); /* é™°å½±æ•ˆæœ */
            transition: background-color 0.3s; /* éæ¸¡æ•ˆæœ */
            z-index: 5; /* ç¢ºä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Šï¼Œä½†ä½æ–¼ game-over */
            cursor: pointer; /* æ»‘é¼ æŒ‡é‡è®Šç‚ºæ‰‹å‹ */
            border: none; /* ç§»é™¤æŒ‰éˆ•é è¨­é‚Šæ¡† */
        }
        #main-feedback-button:hover {
            background-color: #a08d7a; /* é¼ æ¨™æ‡¸åœæ™‚çš„èƒŒæ™¯é¡è‰² */
        }

        /* æ–°å¢ï¼šæ„è¦‹åé¥‹é¸é …å®¹å™¨æ¨£å¼ */
        #feedback-options {
            display: none; /* é è¨­éš±è— */
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            gap: 10px; /* æŒ‰éˆ•é–“è· */
            position: fixed; /* å›ºå®šå®šä½ */
            bottom: 20px; /* è·é›¢åº•éƒ¨ 20px */
            right: 20px; /* è·é›¢å³å´ 20px */
            background-color: rgba(255, 255, 255, 0.9); /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
            padding: 15px; /* å…§é‚Šè· */
            border-radius: 8px; /* åœ“è§’ */
            box-shadow: 0px 4px 15px rgba(0,0,0,0.2); /* é™°å½±æ•ˆæœ */
            z-index: 6; /* æ¯”ä¸»æŒ‰éˆ•é«˜ä¸€é» */
        }

        /* æ–°å¢ï¼šæ„è¦‹åé¥‹é¸é …æŒ‰éˆ•æ¨£å¼ */
        #feedback-options button {
            background-color: #6d5e53; /* æ·±ä¸€é»çš„é¡è‰² */
            color: #fff;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        #feedback-options button:hover {
            background-color: #776e65;
        }

        /* æ–°å¢ï¼šæš«åœæŒ‰éˆ•æ¨£å¼ */
        #pause-button {
            position: fixed; /* å›ºå®šå®šä½ */
            top: 20px; /* è·é›¢é ‚éƒ¨ 20px */
            right: 20px; /* è·é›¢å³å´ 20px */
            background-color: #5cb85c; /* ç¶ è‰² */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            transition: background-color 0.3s;
            z-index: 7; /* åœ¨æ„è¦‹åé¥‹ä¹‹ä¸Š */
            display: none; /* é è¨­éš±è— */
        }
        #pause-button:hover {
            background-color: #4cae4c;
        }
        #pause-button.paused {
            background-color: #f0ad4e; /* æš«åœæ™‚æ”¹ç‚ºæ©˜è‰² */
        }
        #pause-button.paused:hover {
            background-color: #eea236;
        }

        /* æ–°å¢ï¼šå˜´ç ²é–‹é—œæ¨£å¼ */
        #roast-mode-toggle-container {
            display: flex;
            align-items: center;
            margin-top: 20px; /* èˆ‡ä¸Šæ–¹æŒ‰éˆ•ä¿æŒè·é›¢ */
            background-color: #f5f5f5;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }

        #roast-mode-toggle-container label {
            font-size: 16px;
            color: #776e65;
            margin-right: 10px;
            font-weight: bold;
        }

        #roast-mode-toggle {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        #roast-mode-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* Slider */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #8f7a66; /* é–‹å•Ÿæ™‚é¡è‰² */
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #8f7a66;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(16px);
            -ms-transform: translateX(16px);
            transform: translateX(16px);
        }
    </style>
</head>
<body>
    <div id="difficulty-selection">
        <p>é¸æ“‡é›£åº¦ï¼š</p>
        <button onclick="startTutorial()">æ•™å­¸æ¨¡å¼</button>
        <button onclick="setBoardSize(4)">4x4</button>
        <button onclick="setBoardSize(5)">5x5</button>
        <button onclick="setBoardSize(6)">6x6</button>
        <button onclick="setBoardSize(7)">7x7</button>
        <div id="roast-mode-toggle-container">
            <label for="roast-mode-checkbox">å˜´ç ²é–‹é—œ</label>
            <label class="switch" id="roast-mode-toggle">
                <input type="checkbox" id="roast-mode-checkbox" checked>
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div id="game-info" style="display: none;">
        <div id="score-board">Score: <span id="score">0</span></div>
    </div>

    <div id="game-board" style="display: none;"></div>

    <div id="timer-display-container" style="display: none;">
        <div id="timer-display">Time: <span id="time">00:00</span></div>
    </div>

    <div id="game-over" style="display: none;">
        <p id="game-over-message">Game Over!</p>
        <button onclick="restartGame()">Restart</button>
    </div>
    <button id="home-button" onclick="goHome()">å›åˆ°ä¸»é </button>

    <button id="main-feedback-button">æ„è¦‹åé¥‹</button>

    <div id="feedback-options">
        <button id="feedback-web">æœªå®‰è£ Gmail ç¨‹å¼ (é›»è…¦é»é€™å€‹)</button>
        <button id="feedback-app">å·²å®‰è£ Gmail ç¨‹å¼ (æ‰‹æ©Ÿé»é€™å€‹)</button>
    </div>

    <button id="pause-button" style="display: none;">æš«åœ</button>

    <script>
        /* å…¨åŸŸè®Šæ•¸ */
        let boardSize = 4; // éŠæˆ²æ¿çš„å°ºå¯¸ (ä¾‹å¦‚ 4x4, 5x5)
        let board = []; // éŠæˆ²æ¿çš„äºŒç¶­é™£åˆ—ï¼Œå„²å­˜æ–¹å¡Šæ•¸å€¼
        let score = 0; // ç•¶å‰åˆ†æ•¸
        let isTutorial = false; // æ˜¯å¦è™•æ–¼æ•™å­¸æ¨¡å¼
        let tutorialStep = 0; // æ•™å­¸æ¨¡å¼çš„æ­¥é©Ÿ
        let gameActive = false; // æ–°å¢æ——æ¨™ï¼šéŠæˆ²æ˜¯å¦æ´»èº (å¯ä»¥æ»‘å‹•)
        let timerId = null; // è¨ˆæ™‚å™¨ ID
        let totalSeconds = 0; // ç¸½ç§’æ•¸
        let isPaused = false; // éŠæˆ²æ˜¯å¦æš«åœ

        // å˜´ç ²æ¨¡å¼é–‹é—œç‹€æ…‹ï¼Œå¾ localStorage è®€å–æˆ–é è¨­é–‹å•Ÿ
        let isRoastModeEnabled = localStorage.getItem('roastMode') === 'disabled' ? false : true;

        // æ•™å­¸æ¨¡å¼çš„æ­¥é©Ÿå®šç¾©
        const tutorialSteps = [
            {
                message: 'æ­¡è¿ä¾†åˆ°2048æ•™å­¸ï¼é¦–å…ˆï¼Œè©¦è‘—å‘å·¦æ»‘ï¼Œè®“å…©å€‹ 2 åˆä½µæˆ 4ï¼',
                board: [
                    [2, 2, 0, 0],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0],
                ],
                expectedMove: 'left' // æ­¤æ­¥é©Ÿé æœŸçš„ç§»å‹•æ–¹å‘
            },
            {
                message: 'å¤ªæ£’äº†ï¼ç¾åœ¨ï¼Œè«‹å‘ä¸Šæ»‘ï¼Œæº–å‚™è¿æ¥ä¸‹ä¸€å€‹åˆä½µï¼',
                board: [
                    [0, 0, 0, 0],
                    [4, 0, 0, 0],
                    [4, 0, 0, 0],
                    [0, 0, 0, 0],
                ],
                expectedMove: 'up' // æ­¤æ­¥é©Ÿé æœŸçš„ç§»å‹•æ–¹å‘
            },
            {
                message: 'å®Œç¾æ”¶å·¥ ğŸ‰ ä½ å·²ç¶“å­¸æœƒ2048æ€éº¼ç©äº†ï¼',
                board: [
                    [8, 0, 0, 0],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0],
                ],
                expectedMove: null // æ²’æœ‰é æœŸå‹•ä½œï¼Œè¡¨ç¤ºæ•™å­¸æ¨¡å¼çµæŸ
            },
            {
                message: 'éŠæˆ²é–‹å§‹å¾Œï¼Œå·¦ä¸Šè§’æœƒé¡¯ç¤ºä½ çš„åˆ†æ•¸ï¼Œä¸‹æ–¹å‰‡æœƒé¡¯ç¤ºä½ æ‰€èŠ±è²»çš„æ™‚é–“å–”ï¼å¥½å¥½äº«å—éŠæˆ²å§ï¼',
                board: [ // å¯ä»¥ä½¿ç”¨ä¸€å€‹åŸºç¤æ¿é¢
                    [2, 0, 0, 0],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0],
                ],
                expectedMove: null,
                isInfoStep: true // æ¨™è¨˜ç‚ºè³‡è¨Šæ­¥é©Ÿ
            }
        ];

        /* å–å¾— DOM å…ƒç´  */
        const gameBoard = document.getElementById('game-board');
        const gameInfo = document.getElementById('game-info'); // æ–°å¢ï¼šå–å¾— game-info å®¹å™¨
        const scoreBoard = document.getElementById('score-board'); // åˆ†æ•¸æ¿å®¹å™¨
        const scoreDisplay = document.getElementById('score'); // åˆ†æ•¸æ–‡å­—
        const timerDisplayContainer = document.getElementById('timer-display-container'); // è¨ˆæ™‚å™¨å®¹å™¨å¤–å±¤
        const timeDisplay = document.getElementById('time'); // è¨ˆæ™‚å™¨æ–‡å­—
        const gameOverDisplay = document.getElementById('game-over');
        const gameOverMessage = document.getElementById('game-over-message');
        const difficultySelection = document.getElementById('difficulty-selection');
        const homeButton = document.getElementById('home-button');

        // æ„è¦‹åé¥‹ç›¸é—œ DOM å…ƒç´ 
        const mainFeedbackButton = document.getElementById('main-feedback-button');
        const feedbackOptions = document.getElementById('feedback-options');
        const feedbackWebButton = document.getElementById('feedback-web');
        const feedbackAppButton = document.getElementById('feedback-app');

        // æš«åœæŒ‰éˆ• DOM å…ƒç´ 
        const pauseButton = document.getElementById('pause-button');

        // å˜´ç ²é–‹é—œ DOM å…ƒç´ 
        const roastModeToggleContainer = document.getElementById('roast-mode-toggle-container');
        const roastModeCheckbox = document.getElementById('roast-mode-checkbox');

        // --- åˆå§‹åŒ–å˜´ç ²é–‹é—œç‹€æ…‹ ---
        roastModeCheckbox.checked = isRoastModeEnabled;

        // --- æ„è¦‹åé¥‹å½ˆå‡ºé‚è¼¯ ---
        const emailAddress = "hsc0529.myself.tw@gmail.com";
        const subject = "2048éŠæˆ²æ„è¦‹åé¥‹";
        const body = "ï¼ˆè«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„æ„è¦‹æˆ–å»ºè­°ï¼‰";

        mainFeedbackButton.addEventListener('click', () => {
            feedbackOptions.style.display = feedbackOptions.style.display === 'flex' ? 'none' : 'flex';
        });

        feedbackWebButton.addEventListener('click', () => {
            window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${emailAddress}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
            feedbackOptions.style.display = 'none';
        });

        feedbackAppButton.addEventListener('click', () => {
            window.location.href = `mailto:${emailAddress}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            feedbackOptions.style.display = 'none';
        });

        // é»æ“Šé¸é …å¤–éƒ¨å€åŸŸæ™‚éš±è—é¸é …
        document.addEventListener('click', (event) => {
            // æª¢æŸ¥é»æ“Šçš„ç›®æ¨™æ˜¯å¦æ˜¯æ„è¦‹åé¥‹æŒ‰éˆ•æˆ–é¸é …å®¹å™¨å…§éƒ¨
            if (!feedbackOptions.contains(event.target) && event.target !== mainFeedbackButton) {
                feedbackOptions.style.display = 'none';
            }
        });
        // --- æ„è¦‹åé¥‹å½ˆå‡ºé‚è¼¯ END ---

        // --- æš«åœ/ç¹¼çºŒåŠŸèƒ½é‚è¼¯ ---
        pauseButton.addEventListener('click', togglePause);

        function togglePause() {
            if (isPaused) {
                // å¾æš«åœæ¢å¾©
                isPaused = false;
                gameActive = true; // æ¢å¾©éŠæˆ²æ“ä½œ
                startTimer(); // æ¢å¾©è¨ˆæ™‚
                pauseButton.textContent = 'æš«åœ';
                pauseButton.classList.remove('paused');
                // å¦‚æœéŠæˆ²çµæŸç•«é¢æ˜¯æš«åœæ™‚é¡¯ç¤ºçš„è¨Šæ¯ï¼Œå‰‡éš±è—å®ƒ
                if (gameOverDisplay.style.display === 'block' && gameOverDisplay.querySelector('button').style.display === 'none') {
                    gameOverDisplay.style.display = 'none';
                }
            } else {
                // æš«åœéŠæˆ²
                isPaused = true;
                gameActive = false; // ç¦æ­¢éŠæˆ²æ“ä½œ
                stopTimer(); // åœæ­¢è¨ˆæ™‚
                pauseButton.textContent = 'ç¹¼çºŒ';
                pauseButton.classList.add('paused');
                showMessage('éŠæˆ²å·²æš«åœ', false); // é¡¯ç¤ºæš«åœè¨Šæ¯ï¼Œä¸é¡¯ç¤º Restart
            }
        }
        // --- æš«åœ/ç¹¼çºŒåŠŸèƒ½é‚è¼¯ END ---

        // --- è¨ˆæ™‚å™¨åŠŸèƒ½é‚è¼¯ ---
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const formattedMinutes = String(minutes).padStart(2, '0');
            const formattedSeconds = String(remainingSeconds).padStart(2, '0');
            return `${formattedMinutes}:${formattedSeconds}`;
        }

        function startTimer() {
            if (timerId) { // å¦‚æœå·²ç¶“æœ‰è¨ˆæ™‚å™¨åœ¨è·‘ï¼Œå…ˆæ¸…é™¤
                clearInterval(timerId);
            }
            timerId = setInterval(() => {
                totalSeconds++;
                timeDisplay.textContent = formatTime(totalSeconds);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerId);
            timerId = null;
        }

        function resetTimer() {
            stopTimer();
            totalSeconds = 0;
            timeDisplay.textContent = formatTime(totalSeconds);
        }
        // --- è¨ˆæ™‚å™¨åŠŸèƒ½é‚è¼¯ END ---

        /**
         * å•Ÿå‹•æ•™å­¸æ¨¡å¼ã€‚
         * è¨­ç½®æ•™å­¸æ¨¡å¼ç›¸é—œè®Šæ•¸ï¼Œéš±è—é›£åº¦é¸æ“‡ï¼Œé¡¯ç¤ºéŠæˆ²ä»‹é¢ï¼Œä¸¦åŠ è¼‰ç¬¬ä¸€æ­¥æ•™å­¸ã€‚
         */
        function startTutorial() {
            isTutorial = true;
            tutorialStep = 0;
            boardSize = 4; // æ•™å­¸æ¨¡å¼å›ºå®š 4x4
            hideAllGameElements(); // éš±è—æ‰€æœ‰éŠæˆ²ç›¸é—œå…ƒç´ 
            difficultySelection.style.display = 'none'; // éš±è—é›£åº¦é¸æ“‡
            roastModeToggleContainer.style.display = 'none'; // éš±è—å˜´ç ²é–‹é—œ

            // ç¢ºä¿åˆ†æ•¸æ¿å’Œè¨ˆæ™‚å™¨å®¹å™¨åœ¨æ•™å­¸æ¨¡å¼é¡¯ç¤º
            gameInfo.style.display = 'flex'; // é¡¯ç¤ºåˆ†æ•¸æ¿å®¹å™¨
            scoreBoard.style.display = 'block'; // é¡¯ç¤ºåˆ†æ•¸æ¿ (ç¢ºä¿å®ƒå…§éƒ¨æ˜¯block)
            timerDisplayContainer.style.display = 'block'; // é¡¯ç¤ºè¨ˆæ™‚å™¨å®¹å™¨

            gameBoard.style.display = 'grid'; // é¡¯ç¤ºéŠæˆ²æ¿
            homeButton.style.display = 'block'; // é¡¯ç¤ºå›åˆ°ä¸»é æŒ‰éˆ•
            pauseButton.style.display = 'block'; // é¡¯ç¤ºæš«åœæŒ‰éˆ•

            // è¨­å®š CSS è®Šæ•¸ä¾†èª¿æ•´æ–¹å¡Šå¤§å°å’Œé–“è·
            gameBoard.style.setProperty('--board-size', boardSize);
            const tileCalcSize = `calc((100vw - 40px - (var(--grid-gap) * ${boardSize + 1})) / ${boardSize})`;
            gameBoard.style.setProperty('--tile-size', `min(100px, ${tileCalcSize})`);
            gameBoard.style.setProperty('--grid-gap', '10px');
            gameBoard.style.gridTemplateColumns = `repeat(${boardSize}, var(--tile-size))`;

            initGame(); // å…ˆåˆå§‹åŒ–éŠæˆ²æ¿çš„ç©ºæ–¹å¡Š
            resetTimer(); // é‡ç½®è¨ˆæ™‚å™¨ï¼Œä½†ä¸å•Ÿå‹• (ç”± loadTutorialStep æ±ºå®šä½•æ™‚å•Ÿå‹•)
            loadTutorialStep(); // åŠ è¼‰æ•™å­¸æ¨¡å¼çš„ç¬¬ä¸€æ­¥
            // gameActive ç”± loadTutorialStep è¨­å®šï¼Œç¢ºä¿è³‡è¨Šæ­¥é©Ÿä¸å¯æ»‘å‹•
            isPaused = false; // ç¢ºä¿ä¸æ˜¯æš«åœç‹€æ…‹
            pauseButton.textContent = 'æš«åœ';
            pauseButton.classList.remove('paused');
        }

        /**
         * åŠ è¼‰æ•™å­¸æ¨¡å¼çš„æŒ‡å®šæ­¥é©Ÿã€‚
         * æ ¹æ“š tutorialStep è¼‰å…¥å°æ‡‰çš„éŠæˆ²æ¿ç‹€æ…‹å’Œè¨Šæ¯ã€‚
         */
        function loadTutorialStep() {
            const step = tutorialSteps[tutorialStep]; // å–å¾—ç•¶å‰æ•™å­¸æ­¥é©Ÿçš„è³‡æ–™

            if (step.isInfoStep) {
                // å¦‚æœæ˜¯è³‡è¨Šæ­¥é©Ÿ (ä¾‹å¦‚è¨ˆæ™‚å™¨ä»‹ç´¹)ï¼Œé¡¯ç¤ºè¨Šæ¯ï¼Œä¸æ”¹è®Šæ¿é¢ï¼Œä¸æ¥å—æ»‘å‹•
                showMessage(step.message, false); // é¡¯ç¤ºè¨Šæ¯ï¼Œä¸é¡¯ç¤º Restart æŒ‰éˆ•
                gameActive = false; // è³‡è¨Šæ­¥é©Ÿæ™‚ç¦æ­¢æ»‘å‹•
                stopTimer(); // è³‡è¨Šæ­¥é©Ÿæ™‚åœæ­¢è¨ˆæ™‚
                pauseButton.style.display = 'none'; // è³‡è¨Šæ­¥é©Ÿæ™‚æš«åœæŒ‰éˆ•éš±è—

                // å»¶é²å¾Œè‡ªå‹•é€²å…¥ä¸‹ä¸€æ­¥æˆ–çµæŸæ•™å­¸
                setTimeout(() => {
                    gameOverDisplay.style.display = 'none'; // éš±è—è³‡è¨Šè¨Šæ¯
                    tutorialStep++;
                    if (tutorialStep < tutorialSteps.length) {
                        loadTutorialStep();
                    } else {
                        // æ•™å­¸çµæŸå¾Œè‡ªå‹•è¿”å›ä¸»é 
                        gameActive = false; // æ•™å­¸çµæŸï¼Œåœæ­¢éŠæˆ²æ´»èº
                        goHome();
                        alert('æ•™å­¸å®Œæˆï¼ç¾åœ¨ä½ å¯ä»¥é¸æ“‡é›£åº¦é–‹å§‹è‡ªå·±çš„éŠæˆ²å›‰ï¼');
                    }
                }, 4000); // 4 ç§’å¾Œè‡ªå‹•è·³è½‰
            } else {
                // ä¸€èˆ¬æ•™å­¸æ­¥é©Ÿ (å¯æ“ä½œ)
                board = JSON.parse(JSON.stringify(step.board)); // æ·±æ‹·è²æ•™å­¸æ¿ç‹€æ…‹åˆ°ç•¶å‰éŠæˆ²æ¿
                score = 0; // åˆ†æ•¸æ­¸é›¶ (æ¯å€‹æ•™å­¸æ­¥é©Ÿå¾ 0 åˆ†é–‹å§‹ï¼Œä½†å¯¦éš›éŠæˆ²æ¨¡å¼æœƒç´¯è¨ˆ)
                updateScore(0); // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
                updateBoard(); // æ›´æ–°éŠæˆ²æ¿çš„è¦–è¦ºç‹€æ…‹
                showMessage(step.message, false); // é¡¯ç¤ºç•¶å‰æ­¥é©Ÿçš„æç¤ºè¨Šæ¯ï¼Œä¸é¡¯ç¤º Restart æŒ‰éˆ•
                gameActive = true; // å…è¨±æ»‘å‹•
                // æ•™å­¸æ¨¡å¼ä¸­ï¼Œåªæœ‰åœ¨å¯¦éš›éŠæˆ²æ­¥é©Ÿæ‰å•Ÿå‹•è¨ˆæ™‚
                if (tutorialStep === 0) { // å‡è¨­ç¬¬ä¸€å€‹å¯æ“ä½œæ­¥é©Ÿé–‹å§‹è¨ˆæ™‚
                   startTimer();
                } else {
                    // å¦‚æœä¸æ˜¯ç¬¬ä¸€å€‹å¯æ“ä½œæ­¥é©Ÿï¼Œä¸”ä¹‹å‰æœ‰åœéï¼Œå°±ç¹¼çºŒè¨ˆæ™‚
                    if (!timerId) { // å¦‚æœè¨ˆæ™‚å™¨æ²’åœ¨è·‘
                        startTimer();
                    }
                }
                pauseButton.style.display = 'block'; // é¡¯ç¤ºæš«åœæŒ‰éˆ•
            }
        }

        /**
         * é¡¯ç¤ºéŠæˆ²çµæŸæˆ–å‹åˆ©è¨Šæ¯ã€‚
         * @param {string} msg - è¦é¡¯ç¤ºçš„è¨Šæ¯ã€‚
         * @param {boolean} showRestartButton - æ˜¯å¦é¡¯ç¤º Restart æŒ‰éˆ•ã€‚
         */
        function showMessage(msg, showRestartButton = true) {
            gameOverDisplay.style.display = 'block'; // é¡¯ç¤ºéŠæˆ²çµæŸç•«é¢
            gameOverMessage.textContent = msg; // æ›´æ–°è¨Šæ¯æ–‡å­—
            if (showRestartButton) {
                gameOverDisplay.querySelector('button').style.display = 'inline-block';
            } else {
                gameOverDisplay.querySelector('button').style.display = 'none';
            }
        }

        /**
         * è¨­ç½®éŠæˆ²æ¿å°ºå¯¸ä¸¦é–‹å§‹éŠæˆ²ã€‚
         * @param {number} size - éŠæˆ²æ¿çš„å°ºå¯¸ (ä¾‹å¦‚ 4, 5, 6, 7)ã€‚
         */
        function setBoardSize(size) {
            boardSize = size;
            isTutorial = false; // é€€å‡ºæ•™å­¸æ¨¡å¼
            hideAllGameElements(); // éš±è—æ‰€æœ‰éŠæˆ²ç›¸é—œå…ƒç´ 
            difficultySelection.style.display = 'none'; // éš±è—é›£åº¦é¸æ“‡
            roastModeToggleContainer.style.display = 'none'; // éš±è—å˜´ç ²é–‹é—œ

            // ç¢ºä¿åˆ†æ•¸æ¿å’Œè¨ˆæ™‚å™¨å®¹å™¨åœ¨éŠæˆ²æ¨¡å¼é¡¯ç¤º
            gameInfo.style.display = 'flex'; // é¡¯ç¤ºåˆ†æ•¸æ¿å®¹å™¨
            scoreBoard.style.display = 'block'; // é¡¯ç¤ºåˆ†æ•¸æ¿ (ç¢ºä¿å®ƒå…§éƒ¨æ˜¯block)
            timerDisplayContainer.style.display = 'block'; // é¡¯ç¤ºè¨ˆæ™‚å™¨å®¹å™¨

            gameBoard.style.display = 'grid'; // é¡¯ç¤ºéŠæˆ²æ¿
            homeButton.style.display = 'block'; // é¡¯ç¤ºå›åˆ°ä¸»é æŒ‰éˆ•
            pauseButton.style.display = 'block'; // é¡¯ç¤ºæš«åœæŒ‰éˆ•

            // é—œéµä¿®æ­£ï¼šå‹•æ…‹è¨­å®š CSS è®Šæ•¸ä»¥é©æ‡‰ä¸åŒå°ºå¯¸çš„æ¿é¢
            gameBoard.style.setProperty('--board-size', boardSize);
            const tileCalcSize = `calc((100vw - 40px - (var(--grid-gap) * ${boardSize + 1})) / ${boardSize})`;
            gameBoard.style.setProperty('--tile-size', `min(100px, ${tileCalcSize})`);
            gameBoard.style.setProperty('--grid-gap', '10px');
            gameBoard.style.gridTemplateColumns = `repeat(${boardSize}, var(--tile-size))`;

            initGame(); // åˆå§‹åŒ–éŠæˆ²
            resetTimer(); // é‡ç½®è¨ˆæ™‚å™¨
            startTimer(); // é–‹å§‹è¨ˆæ™‚
            gameActive = true; // éŠæˆ²é–‹å§‹ï¼Œå¯ä»¥æ»‘å‹•
            isPaused = false; // ç¢ºä¿ä¸æ˜¯æš«åœç‹€æ…‹
            pauseButton.textContent = 'æš«åœ';
            pauseButton.classList.remove('paused');
        }

        /**
         * åˆå§‹åŒ–éŠæˆ²ã€‚
         * é‡ç½®åˆ†æ•¸ã€éŠæˆ²æ¿ï¼Œä¸¦ç”Ÿæˆå…©å€‹åˆå§‹æ–¹å¡Šã€‚
         */
        function initGame() {
            score = 0; // åˆ†æ•¸æ­¸é›¶
            updateScore(0); // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
            gameOverDisplay.style.display = 'none'; // éš±è—éŠæˆ²çµæŸç•«é¢
            gameActive = true; // éŠæˆ²é–‹å§‹ï¼Œè¨­å®šç‚ºæ´»èºç‹€æ…‹
            isPaused = false; // ç¢ºä¿ä¸æ˜¯æš«åœç‹€æ…‹
            pauseButton.textContent = 'æš«åœ';
            pauseButton.classList.remove('paused');

            // åˆå§‹åŒ–ä¸€å€‹å¡«å…… 0 çš„äºŒç¶­é™£åˆ—ä½œç‚ºéŠæˆ²æ¿
            board = Array.from({ length: boardSize }, () => Array(boardSize).fill(0));
            gameBoard.innerHTML = ''; // æ¸…ç©ºéŠæˆ²æ¿ä¸Šçš„æ‰€æœ‰æ–¹å¡Š
            // æ ¹æ“š boardSize å‰µå»ºæ–°çš„æ–¹å¡Šå…ƒç´ ä¸¦æ·»åŠ åˆ°éŠæˆ²æ¿
            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    tile.dataset.row = row;
                    tile.dataset.col = col;
                    gameBoard.appendChild(tile);
                }
            }
            // éæ•™å­¸æ¨¡å¼æ‰è‡ªå‹•ç”Ÿæˆæ–¹å¡Šï¼Œæ•™å­¸æ¨¡å¼ç”± loadTutorialStep è¼‰å…¥æŒ‡å®šæ¿é¢
            if (!isTutorial) {
                addRandomTile(); // æ·»åŠ ç¬¬ä¸€å€‹éš¨æ©Ÿæ–¹å¡Š
                addRandomTile(); // æ·»åŠ ç¬¬äºŒå€‹éš¨æ©Ÿæ–¹å¡Š
            }
            updateBoard(); // æ›´æ–°éŠæˆ²æ¿çš„è¦–è¦ºç‹€æ…‹
        }

        /**
         * åœ¨éš¨æ©Ÿçš„ç©ºä½æ·»åŠ ä¸€å€‹æ–°çš„æ–¹å¡Š (2 æˆ– 4)ã€‚
         */
        function addRandomTile() {
            const emptyTiles = []; // å„²å­˜æ‰€æœ‰ç©ºæ–¹å¡Šçš„ä½ç½®
            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    if (board[row][col] === 0) {
                        emptyTiles.push({ row, col }); // å¦‚æœæ–¹å¡Šç‚º 0 (ç©º)ï¼Œå‰‡åŠ å…¥åˆ—è¡¨
                    }
                }
            }
            if (emptyTiles.length > 0) {
                // å¾ç©ºæ–¹å¡Šä¸­éš¨æ©Ÿé¸æ“‡ä¸€å€‹ä½ç½®
                const { row, col } = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
                // 90% æ©Ÿç‡ç”Ÿæˆ 2ï¼Œ10% æ©Ÿç‡ç”Ÿæˆ 4
                board[row][col] = Math.random() < 0.9 ? 2 : 4;
            }
        }

        /**
         * æ›´æ–°éŠæˆ²æ¿çš„è¦–è¦ºç‹€æ…‹ (HTML)ã€‚
         * æ ¹æ“š board é™£åˆ—çš„æ•¸å€¼æ›´æ–°æ¯å€‹æ–¹å¡Šçš„å…§å®¹å’Œæ¨£å¼ã€‚
         */
        function updateBoard() {
            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    // æ ¹æ“š data-row å’Œ data-col å±¬æ€§æ‰¾åˆ°å°æ‡‰çš„æ–¹å¡Šå…ƒç´ 
                    const tile = document.querySelector(`.tile[data-row='${row}'][data-col='${col}']`);
                    const value = board[row][col]; // å–å¾—æ–¹å¡Šæ•¸å€¼
                    tile.textContent = value === 0 ? '' : value; // å¦‚æœç‚º 0 å‰‡é¡¯ç¤ºç‚ºç©ºå­—ä¸²ï¼Œå¦å‰‡é¡¯ç¤ºæ•¸å€¼
                    tile.dataset.value = value; // è¨­ç½® data-value å±¬æ€§ï¼Œç”¨æ–¼ CSS æ¨£å¼
                    // ç§»é™¤ merge é¡åˆ¥ï¼Œç‚ºä¸‹ä¸€æ¬¡å¯èƒ½çš„å‹•ç•«åšæº–å‚™
                    if (tile.classList.contains('merge')) {
                        tile.classList.remove('merge');
                    }
                }
            }
        }

        /**
         * æ›´æ–°åˆ†æ•¸ã€‚
         * @param {number} points - è¦å¢åŠ çš„åˆ†æ•¸ã€‚
         */
        function updateScore(points) {
            score += points; // å¢åŠ åˆ†æ•¸
            scoreDisplay.textContent = score; // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
        }

        /**
         * å°‡ä¸€è¡Œ (æˆ–åˆ—) ä¸­çš„éé›¶æ•¸å­—æ»‘å‹•åˆ°ä¸€å´ï¼Œä¸¦ç”¨é›¶å¡«å……ç©ºä½ã€‚
         * @param {Array<number>} line - è¦è™•ç†çš„ä¸€è¡Œæˆ–ä¸€åˆ—æ•¸å­—ã€‚
         * @returns {Array<number>} - æ»‘å‹•å¾Œçš„æ•¸å­—é™£åˆ—ã€‚
         */
        function slide(line) {
            const filtered = line.filter(val => val !== 0); // éæ¿¾æ‰æ‰€æœ‰ 0
            const zeros = Array(line.length - filtered.length).fill(0); // æ ¹æ“šåŸå§‹é•·åº¦è¨ˆç®—éœ€è¦è£œå……çš„ 0 æ•¸é‡
            return [...filtered, ...zeros]; // å°‡éé›¶æ•¸å­—å’Œ 0 åˆä½µ
        }

        /**
         * åˆä½µä¸€è¡Œ (æˆ–åˆ—) ä¸­ç›¸é„°ä¸”ç›¸åŒæ•¸å€¼çš„æ–¹å¡Šã€‚
         * @param {Array<number>} line - è¦è™•ç†çš„ä¸€è¡Œæˆ–ä¸€åˆ—æ•¸å­—ã€‚
         * @returns {Array<number>} - åˆä½µå¾Œçš„æ•¸å­—é™£åˆ—ã€‚
         */
        function combine(line) {
            for (let i = 0; i < line.length - 1; i++) {
                if (line[i] !== 0 && line[i] === line[i + 1]) { // å¦‚æœç•¶å‰å’Œä¸‹ä¸€å€‹æ–¹å¡Šç›¸åŒä¸”ä¸ç‚º 0
                    line[i] *= 2; // ç•¶å‰æ–¹å¡Šæ•¸å€¼ç¿»å€
                    updateScore(line[i]); // å°‡æ–°ç”Ÿæˆçš„æ–¹å¡Šæ•¸å€¼åŠ åˆ°ç¸½åˆ†
                    line[i + 1] = 0; // ä¸‹ä¸€å€‹æ–¹å¡Šæ­¸é›¶ (è¢«åˆä½µ)
                }
            }
            return line; // è¿”å›è™•ç†å¾Œçš„è¡Œ
        }

        /**
         * è™•ç†éŠæˆ²æ¿çš„ç§»å‹•é‚è¼¯ã€‚
         * æ ¹æ“šæŒ‡å®šæ–¹å‘æ»‘å‹•å’Œåˆä½µæ–¹å¡Šï¼Œä¸¦åœ¨ç§»å‹•å¾Œæ·»åŠ æ–°æ–¹å¡Šï¼ˆéæ•™å­¸æ¨¡å¼ï¼‰ã€‚
         * @param {string} direction - ç§»å‹•æ–¹å‘ ('left', 'right', 'up', 'down')ã€‚
         */
        function move(direction) {
            // å¦‚æœéŠæˆ²ä¸åœ¨æ´»èºç‹€æ…‹ (å·²çµæŸæˆ–å‹åˆ©) æˆ–æš«åœç‹€æ…‹ï¼Œå‰‡ä¸å…è¨±æ»‘å‹•
            if (!gameActive || isPaused) {
                return;
            }

            // å¦‚æœæ˜¯æ•™å­¸æ¨¡å¼ï¼Œæª¢æŸ¥ç©å®¶çš„ç§»å‹•æ˜¯å¦ç¬¦åˆé æœŸ
            if (isTutorial) {
                const step = tutorialSteps[tutorialStep];
                if (step.expectedMove && direction !== step.expectedMove) { // å¦‚æœæœ‰é æœŸå‹•ä½œä¸”æ–¹å‘ä¸ç¬¦
                    alert('éŒ¯äº†å–”ï¼é€™æ­¥è¦å¾€ã€Œ' + (step.expectedMove === 'left' ? 'å·¦' : step.expectedMove === 'right' ? 'å³' : step.expectedMove === 'up' ? 'ä¸Š' : 'ä¸‹') + 'ã€æ‰å°ï¼Œç…§æç¤ºåšå•¦ï¼');
                    return; // éŒ¯èª¤æ–¹å‘ï¼Œä¸åŸ·è¡Œå¾ŒçºŒç§»å‹•é‚è¼¯
                }
            }

            let moved = false; // æ¨™è¨˜æ˜¯å¦æœ‰æ–¹å¡Šå¯¦éš›ç§»å‹•æˆ–åˆä½µ
            // æ·±æ‹·è²ç§»å‹•å‰çš„æ¿é¢ç‹€æ…‹ï¼Œç”¨æ–¼åˆ¤æ–·æ˜¯å¦æœ‰å¯¦éš›ç§»å‹•
            const originalBoard = JSON.parse(JSON.stringify(board));

            // æ ¹æ“šç§»å‹•æ–¹å‘è™•ç†æ¯ä¸€è¡Œæˆ–æ¯ä¸€åˆ—
            for (let i = 0; i < boardSize; i++) {
                let line; // line å¯èƒ½æ˜¯ row (æ©«å‘ç§»å‹•) æˆ– column (ç¸±å‘ç§»å‹•)
                if (direction === 'left' || direction === 'right') {
                    line = [...board[i]]; // å–å¾—ç•¶å‰è¡Œ
                    if (direction === 'right') line.reverse(); // å‘å³ç§»å‹•å‰‡åè½‰è¡Œ

                    line = combine(slide(line)); // æ»‘å‹•ä¸¦åˆä½µ
                    if (direction === 'right') line.reverse(); // å‘å³ç§»å‹•å‰‡å†æ¬¡åè½‰æ¢å¾©é †åº
                    board[i] = line; // æ›´æ–°éŠæˆ²æ¿çš„è¡Œ
                } else { // 'up' or 'down' (è™•ç†åˆ—)
                    line = board.map(r => r[i]); // å–å¾—ç•¶å‰åˆ—
                    if (direction === 'down') line.reverse(); // å‘ä¸‹ç§»å‹•å‰‡åè½‰åˆ—

                    line = combine(slide(line)); // æ»‘å‹•ä¸¦åˆä½µ
                    if (direction === 'down') line.reverse(); // å‘ä¸‹ç§»å‹•å‰‡å†æ¬¡åè½‰æ¢å¾©é †åº
                    for (let j = 0; j < boardSize; j++) {
                        board[j][i] = line[j];
                    }
                }
            }

            // æª¢æŸ¥ç§»å‹•å‰å¾Œæ¿é¢æ˜¯å¦æœ‰ä»»ä½•è®ŠåŒ–ï¼Œåˆ¤æ–·æ˜¯å¦æœ‰å¯¦éš›ç§»å‹•
            for(let r = 0; r < boardSize; r++) {
                for(let c = 0; c < boardSize; c++) {
                    if (originalBoard[r][c] !== board[r][c]) {
                        moved = true; // æœ‰è®ŠåŒ–è¡¨ç¤ºæœ‰ç§»å‹•
                        break;
                    }
                }
                if (moved) break;
            }

            // å¦‚æœæœ‰æ–¹å¡Šç§»å‹•æˆ–åˆä½µ
            if (moved) {
                if (isTutorial) {
                    updateBoard(); // æ›´æ–° UI
                    tutorialStep++; // é€²å…¥æ•™å­¸æ¨¡å¼çš„ä¸‹ä¸€æ­¥
                    if (tutorialStep < tutorialSteps.length) {
                        // ç¨å¾®å»¶é²ï¼Œè®“ç©å®¶çœ‹åˆ°åˆä½µæ•ˆæœå¾Œå†åŠ è¼‰ä¸‹ä¸€æ­¥
                        setTimeout(loadTutorialStep, 500);
                    } else {
                        // æ•™å­¸çµæŸå¾Œè‡ªå‹•è¿”å›ä¸»é 
                        gameActive = false; // æ•™å­¸çµæŸï¼Œåœæ­¢éŠæˆ²æ´»èº
                        stopTimer(); // åœæ­¢è¨ˆæ™‚
                        goHome();
                        alert('æ•™å­¸å®Œæˆï¼ç¾åœ¨ä½ å¯ä»¥é¸æ“‡é›£åº¦é–‹å§‹è‡ªå·±çš„éŠæˆ²å›‰ï¼');
                    }
                } else {
                    // ä¸€èˆ¬éŠæˆ²æ¨¡å¼
                    addRandomTile(); // æ·»åŠ ä¸€å€‹æ–°çš„éš¨æ©Ÿæ–¹å¡Š
                    updateBoard(); // æ›´æ–° UI

                    if (checkWin()) { // æª¢æŸ¥æ˜¯å¦é”åˆ° 2048 å‹åˆ©
                        gameActive = false; // éŠæˆ²å‹åˆ©ï¼Œåœæ­¢éŠæˆ²æ´»èº
                        stopTimer(); // åœæ­¢è¨ˆæ™‚
                        displayWinMessage(); // é¡¯ç¤ºå‹åˆ©è¨Šæ¯
                    } else if (isGameOver()) { // æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸ
                        gameActive = false; // éŠæˆ²çµæŸï¼Œåœæ­¢éŠæˆ²æ´»èº
                        stopTimer(); // åœæ­¢è¨ˆæ™‚
                        displayGameOverMessage(); // é¡¯ç¤º Game Over è¨Šæ¯
                    }
                }
            }
        }

        /**
         * é¡¯ç¤ºéŠæˆ²çµæŸè¨Šæ¯ (æ ¹æ“šå˜´ç ²é–‹é—œ)ã€‚
         */
        function displayGameOverMessage() {
            let message;
            if (isRoastModeEnabled) {
                message = `ä½ æ€éº¼é‚£éº¼èœï¼Œé€£2048éƒ½ç©ä¸åˆ°`;
            } else {
                message = `éŠæˆ²çµæŸ`;
            }
            showMessage(message, true);
        }

        /**
         * é¡¯ç¤ºéŠæˆ²å‹åˆ©è¨Šæ¯ (æ ¹æ“šå˜´ç ²é–‹é—œ)ã€‚
         */
        function displayWinMessage() {
            let message;
            const formattedTime = formatTime(totalSeconds);
            if (isRoastModeEnabled) {
                message = `ä¹Ÿæ²’å¤šå²å®³ï¼Œé‚„ä¸æ˜¯èŠ±äº†${formattedTime}æ‰${score}åˆ†è€Œå·²`;
            } else {
                message = `æ­å–œåˆ°é”2048ä¸¦ä¸”èŠ±äº†${formattedTime}å¾—äº†${score}åˆ†`;
            }
            showMessage(message, true);
        }


        /**
         * æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸ (æ²’æœ‰å¯ç§»å‹•çš„æ–¹å¡Šæˆ–å¯åˆä½µçš„æ–¹å¡Š)ã€‚
         * @returns {boolean} - å¦‚æœéŠæˆ²çµæŸè¿”å› trueï¼Œå¦å‰‡è¿”å› falseã€‚
         */
        function isGameOver() {
            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    if (board[row][col] === 0) return false; // é‚„æœ‰ç©ºä½ï¼ŒæœªçµæŸ
                    // æª¢æŸ¥æ°´å¹³æ–¹å‘æ˜¯å¦æœ‰å¯åˆä½µçš„æ–¹å¡Š
                    if (col < boardSize - 1 && board[row][col] === board[row][col + 1]) return false;
                    // æª¢æŸ¥å‚ç›´æ–¹å‘æ˜¯å¦æœ‰å¯åˆä½µçš„æ–¹å¡Š
                    if (row < boardSize - 1 && board[row][col] === board[row + 1][col]) return false;
                }
            }
            return true; // æ²’æœ‰ç©ºä½ä¸”æ²’æœ‰å¯åˆä½µçš„æ–¹å¡Šï¼ŒéŠæˆ²çµæŸ
        }

        /**
         * é‡æ–°é–‹å§‹éŠæˆ²ã€‚
         */
        function restartGame() {
            initGame(); // é‡æ–°åˆå§‹åŒ–éŠæˆ²
            resetTimer(); // é‡ç½®è¨ˆæ™‚å™¨
            startTimer(); // é–‹å§‹è¨ˆæ™‚
            // ç¢ºä¿æŒ‰éˆ•é‡æ–°ç¶å®šï¼Œ although click listener is already setup once
            gameOverDisplay.querySelector('button').onclick = restartGame;
        }

        /**
         * å›åˆ°ä¸»é é¢ (é›£åº¦é¸æ“‡ç•«é¢)ã€‚
         */
        function goHome() {
            isTutorial = false; // ç¢ºä¿é€€å‡ºæ•™å­¸æ¨¡å¼
            gameActive = false; // éŠæˆ²éæ´»èº
            isPaused = false; // ç¢ºä¿é€€å‡ºæš«åœç‹€æ…‹
            stopTimer(); // åœæ­¢è¨ˆæ™‚
            pauseButton.textContent = 'æš«åœ'; // é‡è¨­æš«åœæŒ‰éˆ•æ–‡å­—
            pauseButton.classList.remove('paused'); // ç§»é™¤æš«åœæ¨£å¼

            hideAllGameElements(); // éš±è—æ‰€æœ‰éŠæˆ²ç›¸é—œå…ƒç´ 
            difficultySelection.style.display = 'flex'; // é¡¯ç¤ºé›£åº¦é¸æ“‡
            roastModeToggleContainer.style.display = 'flex'; // é¡¯ç¤ºå˜´ç ²é–‹é—œ
        }

        /**
         * éš±è—æ‰€æœ‰éŠæˆ²ç›¸é—œçš„é¡¯ç¤ºå…ƒç´ ï¼Œç”¨æ–¼åˆ‡æ›æ¨¡å¼æ™‚çš„æ¸…ç†ã€‚
         */
        function hideAllGameElements() {
            gameOverDisplay.style.display = 'none'; // éš±è—éŠæˆ²çµæŸ/å‹åˆ©è¨Šæ¯
            gameInfo.style.display = 'none'; // éš±è—åˆ†æ•¸æ¿å®¹å™¨
            timerDisplayContainer.style.display = 'none'; // éš±è—è¨ˆæ™‚å™¨å®¹å™¨
            gameBoard.style.display = 'none'; // éš±è—éŠæˆ²æ¿
            homeButton.style.display = 'none'; // éš±è—å›åˆ°ä¸»é æŒ‰éˆ•
            pauseButton.style.display = 'none'; // éš±è—æš«åœæŒ‰éˆ•
        }

        /* äº‹ä»¶ç›£è½å™¨ */

        // éµç›¤æ§åˆ¶ (ç®­é ­éµ)
        document.addEventListener('keydown', e => {
            // åªæœ‰ç•¶éŠæˆ²æ´»èºä¸”æœªæš«åœæ™‚æ‰éŸ¿æ‡‰éµç›¤æ“ä½œ
            if (!gameActive || isPaused) return;

            // æª¢æŸ¥æ˜¯å¦ç‚ºæ–¹å‘éµ
            if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                e.preventDefault(); // é˜²æ­¢é é¢æ»¾å‹• (ç•¶ä½¿ç”¨æ–¹å‘éµæ™‚)
                switch (e.key) {
                    case 'ArrowLeft':
                        move('left');
                        break;
                    case 'ArrowRight':
                        move('right');
                        break;
                    case 'ArrowUp':
                        move('up');
                        break;
                    case 'ArrowDown':
                        move('down');
                        break;
                }
            }
        });

        // --- æ‰‹æ©Ÿè§¸æ§æ»‘å‹•æ§åˆ¶å„ªåŒ– (å°ˆæ³¨æ–¼éŠæˆ²æ¿å…§çš„æ»‘å‹•ï¼Œé¿å…å½±éŸ¿å¤–éƒ¨æŒ‰éˆ•) ---
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoved = false; // æ——æ¨™ï¼Œè¿½è¹¤åœ¨éŠæˆ²æ¿å…§æ˜¯å¦æœ‰å¯¦éš›æ»‘å‹•

        // ç›£è½éŠæˆ²æ¿çš„ touchstart äº‹ä»¶ï¼šè¨˜éŒ„èµ·å§‹åº§æ¨™ï¼Œä¸¦é‡ç½® touchMoved æ——æ¨™ã€‚
        gameBoard.addEventListener('touchstart', function(e) {
            // åªæœ‰ç•¶éŠæˆ²æ´»èºä¸”æœªæš«åœæ™‚æ‰è™•ç†è§¸æ§é–‹å§‹
            if (!gameActive || isPaused) return;

            touchStartX = e.touches[0].clientX; // è¨˜éŒ„è§¸æ‘¸é–‹å§‹çš„ X åº§æ¨™
            touchStartY = e.touches[0].clientY; // è¨˜éŒ„è§¸æ‘¸é–‹å§‹çš„ Y åº§æ¨™
            touchMoved = false; // æ¯æ¬¡è§¸æ‘¸é–‹å§‹æ™‚é‡ç½®ç‚º false
        }, { passive: true });

        // ç›£è½éŠæˆ²æ¿çš„ touchmove äº‹ä»¶ï¼šåˆ¤æ–·æ˜¯å¦æœ‰è¶³å¤ çš„ç§»å‹•é‡ï¼Œä¸¦åœ¨ç§»å‹•æ™‚é˜»æ­¢é é¢æ»¾å‹•ã€‚
        gameBoard.addEventListener('touchmove', function(e) {
            // åªæœ‰ç•¶éŠæˆ²æ´»èºä¸”æœªæš«åœæ™‚æ‰è™•ç†è§¸æ§ç§»å‹•
            if (!gameActive || isPaused) return;

            const dx = e.touches[0].clientX - touchStartX;
            const dy = e.touches[0].clientY - touchStartY;
            const minMoveThreshold = 10; // å®šç¾©ä¸€å€‹å°é–¾å€¼ (ä¾‹å¦‚ 10 åƒç´ )ï¼Œè¶…éå³è¦–ç‚ºç§»å‹•
            if (Math.abs(dx) > minMoveThreshold || Math.abs(dy) > minMoveThreshold) {
                touchMoved = true; // è¨­ç½®ç‚º true è¡¨ç¤ºæœ‰æ»‘å‹•ç™¼ç”Ÿ
            }
            // åœ¨é€™è£¡é˜»æ­¢é è¨­è¡Œç‚ºï¼Œé˜²æ­¢é é¢æ»¾å‹•ã€‚åªæœ‰åœ¨éŠæˆ²æ¿å…§ç§»å‹•æ™‚æ‰æœ‰æ•ˆã€‚
            e.preventDefault();
        }, { passive: false });

        // ç›£è½éŠæˆ²æ¿çš„ touchend äº‹ä»¶ï¼šæ ¹æ“šæ˜¯å¦æœ‰æ»‘å‹•ä¾†åŸ·è¡ŒéŠæˆ²é‚è¼¯ã€‚
        gameBoard.addEventListener('touchend', function(e) {
            // åªæœ‰ç•¶éŠæˆ²æ´»èºä¸”æœªæš«åœæ™‚æ‰è™•ç†è§¸æ§çµæŸ
            if (!gameActive || isPaused) return;

            // å¦‚æœæ²’æœ‰åµæ¸¬åˆ°æ˜é¡¯çš„æ»‘å‹• (å³ touchMoved ä»ç‚º false)ï¼Œ
            // å‰‡èªç‚ºé€™æ˜¯ä¸€æ¬¡é»æ“Šæ“ä½œï¼Œä¸åŸ·è¡ŒéŠæˆ²ç§»å‹•é‚è¼¯ã€‚
            if (!touchMoved) {
                return; // ä¸åŸ·è¡ŒéŠæˆ²ç§»å‹•é‚è¼¯
            }

            const dx = e.changedTouches[0].clientX - touchStartX; // è¨ˆç®— X æ–¹å‘çš„ç§»å‹•è·é›¢
            const dy = e.changedTouches[0].clientY - touchStartY; // è¨ˆç®— Y æ–¹å‘çš„ç§»å‹•è·é›¢

            const minSwipeDistance = 30; // å®šç¾©æœ€å°æ»‘å‹•è·é›¢ï¼Œé¿å…èª¤è§¸
            // åˆ¤æ–·æ˜¯æ°´å¹³æ»‘å‹•é‚„æ˜¯å‚ç›´æ»‘å‹•ï¼Œä¸¦åŸ·è¡Œå°æ‡‰çš„ç§»å‹•
            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > minSwipeDistance) {
                if (dx > 0) move('right'); // å‘å³æ»‘å‹•
                else move('left'); // å‘å·¦æ»‘å‹•
            } else if (Math.abs(dy) > minSwipeDistance) {
                if (dy > 0) move('down'); // å‘ä¸‹æ»‘å‹•
                else move('up'); // å‘ä¸Šæ»‘å‹•
            }
        }, { passive: true });
        // --- è§¸æ§äº‹ä»¶å„ªåŒ–çµæŸ ---

        /**
         * æª¢æŸ¥éŠæˆ²æ˜¯å¦å‹åˆ© (é”åˆ° 2048 æ–¹å¡Š)ã€‚
         * @returns {boolean} - å¦‚æœå‹åˆ©è¿”å› trueï¼Œå¦å‰‡è¿”å› falseã€‚
         */
        function checkWin() {
            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    if (board[row][col] === 2048) {
                        return true; // æ‰¾åˆ° 2048 æ–¹å¡Šï¼Œå‹åˆ©
                    }
                }
            }
            return false; // æœªæ‰¾åˆ° 2048 æ–¹å¡Š
        }

        // --- å˜´ç ²é–‹é—œé‚è¼¯ ---
        roastModeCheckbox.addEventListener('change', () => {
            isRoastModeEnabled = roastModeCheckbox.checked;
            // å°‡ç‹€æ…‹å„²å­˜åˆ° localStorageï¼Œè®“ä¸‹æ¬¡è¼‰å…¥æ™‚ä¹Ÿèƒ½ä¿æŒ
            localStorage.setItem('roastMode', isRoastModeEnabled ? 'enabled' : 'disabled');
        });

    </script>
</body>
</html>